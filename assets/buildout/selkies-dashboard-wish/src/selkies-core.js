(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function i(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(n){if(n.ep)return;n.ep=!0;const l=i(n);fetch(n.href,l)}})();const qt={buttons:{a:0,b:1,x:2,y:3,leftshoulder:4,rightshoulder:5,lefttrigger:6,righttrigger:7,back:8,start:9,leftstick:10,rightstick:11,dpup:12,dpdown:13,dpleft:14,dpright:15,guide:16},axes:{leftx:0,lefty:1,rightx:2,righty:3}},fi=16,hi=4;class pi{constructor(e,i,s){this.gamepad=e,this.onButton=i,this.onAxis=s,this.state={},this._active=!0,this.interval=setInterval(()=>{this._poll()},fi)}enable(){this._active||(this._active=!0,console.log("GamepadManager polling activated."))}disable(){this._active&&(this._active=!1,console.log("GamepadManager polling deactivated."))}async _loadRemapProfile(e,i){i.loadingProfile=!0;const s=`jsdb/${e}.json`;try{console.log(`Attempting to load mapping for ${e} from ${s}`);const n=await fetch(s);if(!n.ok){n.status===404?console.log(`No custom mapping file found for ${e}. Using browser default.`):console.warn(`Failed to load mapping for ${e} (HTTP Status: ${n.status})`),i.remapProfile={};return}const l=await n.json();console.log(`Successfully loaded and applying custom mapping for: ${e}`);const c={buttons:{},axes:{}};for(const p in l){const h=l[p];if(h.type==="button"){const b=qt.buttons[p];b!==void 0&&(c.buttons[h.index]=b)}else if(h.type==="axis"){const b=qt.axes[p];b!==void 0&&(c.axes[h.index]=b)}}i.remapProfile=c}catch(n){console.error(`Error fetching or parsing mapping file for ${e}:`,n),i.remapProfile={}}}_poll(){if(!this._active)return;const e=navigator.getGamepads();for(let i=0;i<hi;i++){const s=e[i];if(s){let n=this.state[i];if(!n&&(n=this.state[i]={axes:new Array(s.axes.length).fill(0),buttons:new Array(s.buttons.length).fill(0),dpadAxisState:{12:!1,13:!1,14:!1,15:!1},remapProfile:null,loadingProfile:!1},s.mapping!=="standard")){const l=s.id.match(/Vendor: ([0-9a-f]{4}) Product: ([0-9a-f]{4})/i);if(l&&!n.loadingProfile){const c=l[1].toLowerCase(),p=l[2].toLowerCase(),h=`${c}-${p}`;this._loadRemapProfile(h,n)}}n.buttons.length!==s.buttons.length&&(n.buttons=new Array(s.buttons.length).fill(0)),n.axes.length!==s.axes.length&&(n.axes=new Array(s.axes.length).fill(0));for(let l=0;l<s.buttons.length;l++){if(s.buttons[l]===void 0)continue;const c=s.buttons[l].value,p=s.buttons[l].pressed;if(n.buttons[l]!==c){let h=l;if(n.remapProfile){const b=n.remapProfile.buttons[l];if(b!==void 0)h=b;else continue}this.onButton(i,h,c,p),n.buttons[l]=c}}for(let l=0;l<s.axes.length;l++){if(s.axes[l]===void 0)continue;let c=s.axes[l];if(Math.abs(c)<.05&&(c=0),n.axes[l]!==c){if(!(s.mapping!=="standard"&&(l===4||l===5))){let h=l;n.remapProfile&&n.remapProfile.axes[l]!==void 0&&(h=n.remapProfile.axes[l]),this.onAxis(i,h,c)}n.axes[l]=c}}if(s.mapping!=="standard"&&s.axes.length>=6){const c={up:s.axes[5]<-.5,down:s.axes[5]>.5,left:s.axes[4]<-.5,right:s.axes[4]>.5};c.up!==n.dpadAxisState[12]&&(this.onButton(i,12,c.up?1:0,c.up),n.dpadAxisState[12]=c.up),c.down!==n.dpadAxisState[13]&&(this.onButton(i,13,c.down?1:0,c.down),n.dpadAxisState[13]=c.down),c.left!==n.dpadAxisState[14]&&(this.onButton(i,14,c.left?1:0,c.left),n.dpadAxisState[14]=c.left),c.right!==n.dpadAxisState[15]&&(this.onButton(i,15,c.right?1:0,c.right),n.dpadAxisState[15]=c.right)}}else this.state[i]&&delete this.state[i]}}destroy(){clearInterval(this.interval),this.state={},console.log("GamepadManager destroyed.")}}class xi{constructor(...e){this.items=[],this.enqueue(...e)}enqueue(...e){e.forEach(i=>this.items.push(i))}dequeue(e=1){return this.items.splice(0,e)[0]}size(){return this.items.length}isEmpty(){return this.items.length===0}toArray(){return[...this.items]}remove(e){var i=this.items.indexOf(e);this.items.splice(i,1)}find(e){return this.items.indexOf(e)!=-1}clear(){this.items.length=0}}const He="allow-native-input",o={XK_BackSpace:65288,XK_Tab:65289,XK_Clear:65291,XK_Return:65293,XK_Pause:65299,XK_Scroll_Lock:65300,XK_Escape:65307,XK_Delete:65535,XK_Multi_key:65312,XK_Codeinput:65335,XK_SingleCandidate:65340,XK_MultipleCandidate:65341,XK_PreviousCandidate:65342,XK_Kanji:65313,XK_Muhenkan:65314,XK_Henkan:65315,XK_Romaji:65316,XK_Hiragana:65317,XK_Katakana:65318,XK_Hiragana_Katakana:65319,XK_Zenkaku:65320,XK_Hankaku:65321,XK_Zenkaku_Hankaku:65322,XK_Kana_Shift:65326,XK_Eisu_toggle:65328,XK_Home:65360,XK_Left:65361,XK_Up:65362,XK_Right:65363,XK_Down:65364,XK_Prior:65365,XK_Page_Up:65365,XK_Next:65366,XK_Page_Down:65366,XK_End:65367,XK_Select:65376,XK_Print:65377,XK_Execute:65378,XK_Insert:65379,XK_Undo:65381,XK_Redo:65382,XK_Menu:65383,XK_Find:65384,XK_Cancel:65385,XK_Help:65386,XK_Mode_switch:65406,XK_Num_Lock:65407,XK_KP_Space:65408,XK_KP_Enter:65421,XK_KP_Home:65429,XK_KP_Left:65430,XK_KP_Up:65431,XK_KP_Right:65432,XK_KP_Down:65433,XK_KP_Prior:65434,XK_KP_Page_Up:65434,XK_KP_Next:65435,XK_KP_Page_Down:65435,XK_KP_End:65436,XK_KP_Begin:65437,XK_KP_Insert:65438,XK_KP_Delete:65439,XK_KP_Equal:65469,XK_KP_Multiply:65450,XK_KP_Add:65451,XK_KP_Separator:65452,XK_KP_Subtract:65453,XK_KP_Decimal:65454,XK_KP_Divide:65455,XK_KP_0:65456,XK_KP_1:65457,XK_KP_2:65458,XK_KP_3:65459,XK_KP_4:65460,XK_KP_5:65461,XK_KP_6:65462,XK_KP_7:65463,XK_KP_8:65464,XK_KP_9:65465,XK_F1:65470,XK_F2:65471,XK_F3:65472,XK_F4:65473,XK_F5:65474,XK_F6:65475,XK_F7:65476,XK_F8:65477,XK_F9:65478,XK_F10:65479,XK_F11:65480,XK_F12:65481,XK_F13:65482,XK_F14:65483,XK_F15:65484,XK_F16:65485,XK_F17:65486,XK_F18:65487,XK_F19:65488,XK_F20:65489,XK_F21:65490,XK_F22:65491,XK_F23:65492,XK_F24:65493,XK_F25:65494,XK_F26:65495,XK_F27:65496,XK_F28:65497,XK_F29:65498,XK_F30:65499,XK_F31:65500,XK_F32:65501,XK_F33:65502,XK_F34:65503,XK_F35:65504,XK_Shift_L:65505,XK_Shift_R:65506,XK_Control_L:65507,XK_Control_R:65508,XK_Caps_Lock:65509,XK_Meta_L:65511,XK_Meta_R:65512,XK_Alt_L:65513,XK_Alt_R:65514,XK_Super_L:65515,XK_Super_R:65516,XK_ISO_Level3_Shift:65027,XK_ISO_Next_Group:65032,XK_ISO_Prev_Group:65034,XK_ISO_First_Group:65036,XK_ISO_Last_Group:65038,XK_space:32,XK_asterisk:42,XK_plus:43,XK_comma:44,XK_minus:45,XK_period:46,XK_slash:47,XK_0:48,XK_1:49,XK_2:50,XK_3:51,XK_4:52,XK_5:53,XK_6:54,XK_7:55,XK_8:56,XK_9:57,XK_equal:61,XK_Hangul:65329,XK_Hangul_Hanja:65332,XK_Hangul_Jeonja:65336,XF86XK_MonBrightnessUp:269025026,XF86XK_MonBrightnessDown:269025027,XF86XK_Standby:269025040,XF86XK_AudioLowerVolume:269025041,XF86XK_AudioMute:269025042,XF86XK_AudioRaiseVolume:269025043,XF86XK_AudioPlay:269025044,XF86XK_AudioStop:269025045,XF86XK_AudioPrev:269025046,XF86XK_AudioNext:269025047,XF86XK_HomePage:269025048,XF86XK_Mail:269025049,XF86XK_Search:269025051,XF86XK_AudioRecord:269025052,XF86XK_Calculator:269025053,XF86XK_Calendar:269025056,XF86XK_PowerDown:269025057,XF86XK_Back:269025062,XF86XK_Forward:269025063,XF86XK_Stop:269025064,XF86XK_Refresh:269025065,XF86XK_PowerOff:269025066,XF86XK_WakeUp:269025067,XF86XK_Eject:269025068,XF86XK_ScreenSaver:269025069,XF86XK_WWW:269025070,XF86XK_Favorites:269025072,XF86XK_AudioPause:269025073,XF86XK_AudioMedia:269025074,XF86XK_MyComputer:269025075,XF86XK_BrightnessAdjust:269025083,XF86XK_AudioRewind:269025086,XF86XK_Close:269025110,XF86XK_Copy:269025111,XF86XK_Cut:269025112,XF86XK_Excel:269025116,XF86XK_LogOff:269025121,XF86XK_New:269025128,XF86XK_Open:269025131,XF86XK_Paste:269025133,XF86XK_Phone:269025134,XF86XK_Reply:269025138,XF86XK_Save:269025143,XF86XK_Send:269025147,XF86XK_Spell:269025148,XF86XK_SplitScreen:269025149,XF86XK_Word:269025161,XF86XK_ZoomIn:269025163,XF86XK_ZoomOut:269025164,XF86XK_WebCam:269025167,XF86XK_MailForward:269025168,XF86XK_Music:269025170,XF86XK_AudioForward:269025175,XF86XK_AudioRandomPlay:269025177,XF86XK_Subtitle:269025178,XF86XK_AudioCycleTrack:269025179,XF86XK_Hibernate:269025192,XF86XK_AudioMicMute:269025202,XF86XK_Next_VMode:269024802},gi={256:960,257:992,258:451,259:483,260:417,261:433,262:454,263:486,264:710,265:742,266:709,267:741,268:456,269:488,270:463,271:495,272:464,273:496,274:938,275:954,278:972,279:1004,280:458,281:490,282:460,283:492,284:728,285:760,286:683,287:699,288:725,289:757,290:939,291:955,292:678,293:694,294:673,295:689,296:933,297:949,298:975,299:1007,302:967,303:999,304:681,305:697,308:684,309:700,310:979,311:1011,312:930,313:453,314:485,315:934,316:950,317:421,318:437,321:419,322:435,323:465,324:497,325:977,326:1009,327:466,328:498,330:957,331:959,332:978,333:1010,336:469,337:501,338:5052,339:5053,340:448,341:480,342:931,343:947,344:472,345:504,346:422,347:438,348:734,349:766,350:426,351:442,352:425,353:441,354:478,355:510,356:427,357:443,358:940,359:956,360:989,361:1021,362:990,363:1022,364:733,365:765,366:473,367:505,368:475,369:507,370:985,371:1017,376:5054,377:428,378:444,379:431,380:447,381:430,382:446,402:2294,466:16777681,711:439,728:418,729:511,731:434,733:445,901:1966,902:1953,904:1954,905:1955,906:1956,908:1959,910:1960,911:1963,912:1974,913:1985,914:1986,915:1987,916:1988,917:1989,918:1990,919:1991,920:1992,921:1993,922:1994,923:1995,924:1996,925:1997,926:1998,927:1999,928:2e3,929:2001,931:2002,932:2004,933:2005,934:2006,935:2007,936:2008,937:2009,938:1957,939:1961,940:1969,941:1970,942:1971,943:1972,944:1978,945:2017,946:2018,947:2019,948:2020,949:2021,950:2022,951:2023,952:2024,953:2025,954:2026,955:2027,956:2028,957:2029,958:2030,959:2031,960:2032,961:2033,962:2035,963:2034,964:2036,965:2037,966:2038,967:2039,968:2040,969:2041,970:1973,971:1977,972:1975,973:1976,974:1979,1025:1715,1026:1713,1027:1714,1028:1716,1029:1717,1030:1718,1031:1719,1032:1720,1033:1721,1034:1722,1035:1723,1036:1724,1038:1726,1039:1727,1040:1761,1041:1762,1042:1783,1043:1767,1044:1764,1045:1765,1046:1782,1047:1786,1048:1769,1049:1770,1050:1771,1051:1772,1052:1773,1053:1774,1054:1775,1055:1776,1056:1778,1057:1779,1058:1780,1059:1781,1060:1766,1061:1768,1062:1763,1063:1790,1064:1787,1065:1789,1066:1791,1067:1785,1068:1784,1069:1788,1070:1760,1071:1777,1072:1729,1073:1730,1074:1751,1075:1735,1076:1732,1077:1733,1078:1750,1079:1754,1080:1737,1081:1738,1082:1739,1083:1740,1084:1741,1085:1742,1086:1743,1087:1744,1088:1746,1089:1747,1090:1748,1091:1749,1092:1734,1093:1736,1094:1731,1095:1758,1096:1755,1097:1757,1098:1759,1099:1753,1100:1752,1101:1756,1102:1728,1103:1745,1105:1699,1106:1697,1107:1698,1108:1700,1109:1701,1110:1702,1111:1703,1112:1704,1113:1705,1114:1706,1115:1707,1116:1708,1118:1710,1119:1711,1168:1725,1169:1709,1488:3296,1489:3297,1490:3298,1491:3299,1492:3300,1493:3301,1494:3302,1495:3303,1496:3304,1497:3305,1498:3306,1499:3307,1500:3308,1501:3309,1502:3310,1503:3311,1504:3312,1505:3313,1506:3314,1507:3315,1508:3316,1509:3317,1510:3318,1511:3319,1512:3320,1513:3321,1514:3322,1548:1452,1563:1467,1567:1471,1569:1473,1570:1474,1571:1475,1572:1476,1573:1477,1574:1478,1575:1479,1576:1480,1577:1481,1578:1482,1579:1483,1580:1484,1581:1485,1582:1486,1583:1487,1584:1488,1585:1489,1586:1490,1587:1491,1588:1492,1589:1493,1590:1494,1591:1495,1592:1496,1593:1497,1594:1498,1600:1504,1601:1505,1602:1506,1603:1507,1604:1508,1605:1509,1606:1510,1607:1511,1608:1512,1609:1513,1610:1514,1611:1515,1612:1516,1613:1517,1614:1518,1615:1519,1616:1520,1617:1521,1618:1522,3585:3489,3586:3490,3587:3491,3588:3492,3589:3493,3590:3494,3591:3495,3592:3496,3593:3497,3594:3498,3595:3499,3596:3500,3597:3501,3598:3502,3599:3503,3600:3504,3601:3505,3602:3506,3603:3507,3604:3508,3605:3509,3606:3510,3607:3511,3608:3512,3609:3513,3610:3514,3611:3515,3612:3516,3613:3517,3614:3518,3615:3519,3616:3520,3617:3521,3618:3522,3619:3523,3620:3524,3621:3525,3622:3526,3623:3527,3624:3528,3625:3529,3626:3530,3627:3531,3628:3532,3629:3533,3630:3534,3631:3535,3632:3536,3633:3537,3634:3538,3635:3539,3636:3540,3637:3541,3638:3542,3639:3543,3640:3544,3641:3545,3642:3546,3647:3551,3648:3552,3649:3553,3650:3554,3651:3555,3652:3556,3653:3557,3654:3558,3655:3559,3656:3560,3657:3561,3658:3562,3659:3563,3660:3564,3661:3565,3664:3568,3665:3569,3666:3570,3667:3571,3668:3572,3669:3573,3670:3574,3671:3575,3672:3576,3673:3577,8194:2722,8195:2721,8196:2723,8197:2724,8199:2725,8200:2726,8201:2727,8202:2728,8210:2747,8211:2730,8212:2729,8213:1967,8215:3295,8216:2768,8217:2769,8218:2813,8220:2770,8221:2771,8222:2814,8224:2801,8225:2802,8226:2790,8229:2735,8230:2734,8240:2773,8242:2774,8243:2775,8248:2812,8254:1150,8361:3839,8364:8364,8453:2744,8470:1712,8471:2811,8478:2772,8482:2761,8531:2736,8532:2737,8533:2738,8534:2739,8535:2740,8536:2741,8537:2742,8538:2743,8539:2755,8540:2756,8541:2757,8542:2758,8592:2299,8593:2300,8594:2301,8595:2302,8658:2254,8660:2253,8706:2287,8711:2245,8728:3018,8730:2262,8733:2241,8734:2242,8743:2270,8744:2271,8745:2268,8746:2269,8747:2239,8756:2240,8764:2248,8771:2249,8773:16785992,8800:2237,8801:2255,8804:2236,8805:2238,8834:2266,8835:2267,8866:3068,8867:3036,8868:3010,8869:3022,8968:3027,8970:3012,8981:2810,8992:2212,8993:2213,9109:3020,9115:2219,9117:2220,9118:2221,9120:2222,9121:2215,9123:2216,9124:2217,9126:2218,9128:2223,9132:2224,9143:2209,9146:2543,9147:2544,9148:2546,9149:2547,9225:2530,9226:2533,9227:2537,9228:2531,9229:2532,9251:2732,9252:2536,9472:2211,9474:2214,9484:2210,9488:2539,9492:2541,9496:2538,9500:2548,9508:2549,9516:2551,9524:2550,9532:2542,9618:2529,9642:2791,9643:2785,9644:2779,9645:2786,9646:2783,9647:2767,9650:2792,9651:2787,9654:2781,9655:2765,9660:2793,9661:2788,9664:2780,9665:2764,9670:2528,9675:2766,9679:2782,9702:2784,9734:2789,9742:2809,9747:2762,9756:2794,9758:2795,9792:2808,9794:2807,9827:2796,9829:2798,9830:2797,9837:2806,9839:2805,10003:2803,10007:2804,10013:2777,10016:2800,10216:2748,10217:2750,12289:1188,12290:1185,12300:1186,12301:1187,12443:1246,12444:1247,12449:1191,12450:1201,12451:1192,12452:1202,12453:1193,12454:1203,12455:1194,12456:1204,12457:1195,12458:1205,12459:1206,12461:1207,12463:1208,12465:1209,12467:1210,12469:1211,12471:1212,12473:1213,12475:1214,12477:1215,12479:1216,12481:1217,12483:1199,12484:1218,12486:1219,12488:1220,12490:1221,12491:1222,12492:1223,12493:1224,12494:1225,12495:1226,12498:1227,12501:1228,12504:1229,12507:1230,12510:1231,12511:1232,12512:1233,12513:1234,12514:1235,12515:1196,12516:1236,12517:1197,12518:1237,12519:1198,12520:1238,12521:1239,12522:1240,12523:1241,12524:1242,12525:1243,12527:1244,12530:1190,12531:1245,12539:1189,12540:1200},Ye={lookup:function(t){if(t>=32&&t<=255)return t;const e=gi[t];return e!==void 0?e:16777216|t}},Se={};(function(){function t(s,n){if(n===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in Se)throw new Error('Duplicate entry for key "'+s+'"');Se[s]=[n,n,n,n]}function e(s,n,l){if(n===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(l===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in Se)throw new Error('Duplicate entry for key "'+s+'"');Se[s]=[n,n,l,n]}function i(s,n,l){if(n===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(l===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in Se)throw new Error('Duplicate entry for key "'+s+'"');Se[s]=[n,n,n,l]}e("Alt",o.XK_Alt_L,o.XK_Alt_R),t("AltGraph",o.XK_ISO_Level3_Shift),t("CapsLock",o.XK_Caps_Lock),e("Control",o.XK_Control_L,o.XK_Control_R),e("Meta",o.XK_Super_L,o.XK_Super_R),t("NumLock",o.XK_Num_Lock),t("ScrollLock",o.XK_Scroll_Lock),e("Shift",o.XK_Shift_L,o.XK_Shift_R),i("Enter",o.XK_Return,o.XK_KP_Enter),t("Tab",o.XK_Tab),i(" ",o.XK_space,o.XK_KP_Space),i("ArrowDown",o.XK_Down,o.XK_KP_Down),i("ArrowLeft",o.XK_Left,o.XK_KP_Left),i("ArrowRight",o.XK_Right,o.XK_KP_Right),i("ArrowUp",o.XK_Up,o.XK_KP_Up),i("End",o.XK_End,o.XK_KP_End),i("Home",o.XK_Home,o.XK_KP_Home),i("PageDown",o.XK_Next,o.XK_KP_Next),i("PageUp",o.XK_Prior,o.XK_KP_Prior),t("Backspace",o.XK_BackSpace),i("Clear",o.XK_Clear,o.XK_KP_Begin),t("Copy",o.XF86XK_Copy),t("Cut",o.XF86XK_Cut),i("Delete",o.XK_Delete,o.XK_KP_Delete),i("Insert",o.XK_Insert,o.XK_KP_Insert),t("Paste",o.XF86XK_Paste),t("Redo",o.XK_Redo),t("Undo",o.XK_Undo),t("Cancel",o.XK_Cancel),t("ContextMenu",o.XK_Menu),t("Escape",o.XK_Escape),t("Execute",o.XK_Execute),t("Find",o.XK_Find),t("Help",o.XK_Help),t("Pause",o.XK_Pause),t("Select",o.XK_Select),t("ZoomIn",o.XF86XK_ZoomIn),t("ZoomOut",o.XF86XK_ZoomOut),t("BrightnessDown",o.XF86XK_MonBrightnessDown),t("BrightnessUp",o.XF86XK_MonBrightnessUp),t("Eject",o.XF86XK_Eject),t("LogOff",o.XF86XK_LogOff),t("Power",o.XF86XK_PowerOff),t("PowerOff",o.XF86XK_PowerDown),t("PrintScreen",o.XK_Print),t("Hibernate",o.XF86XK_Hibernate),t("Standby",o.XF86XK_Standby),t("WakeUp",o.XF86XK_WakeUp),t("AllCandidates",o.XK_MultipleCandidate),t("Alphanumeric",o.XK_Eisu_toggle),t("CodeInput",o.XK_Codeinput),t("Compose",o.XK_Multi_key),t("Convert",o.XK_Henkan),t("GroupFirst",o.XK_ISO_First_Group),t("GroupLast",o.XK_ISO_Last_Group),t("GroupNext",o.XK_ISO_Next_Group),t("GroupPrevious",o.XK_ISO_Prev_Group),t("NonConvert",o.XK_Muhenkan),t("PreviousCandidate",o.XK_PreviousCandidate),t("SingleCandidate",o.XK_SingleCandidate),t("HangulMode",o.XK_Hangul),t("HanjaMode",o.XK_Hangul_Hanja),t("JunjaMode",o.XK_Hangul_Jeonja),t("Eisu",o.XK_Eisu_toggle),t("Hankaku",o.XK_Hankaku),t("Hiragana",o.XK_Hiragana),t("HiraganaKatakana",o.XK_Hiragana_Katakana),t("KanaMode",o.XK_Kana_Shift),t("KanjiMode",o.XK_Kanji),t("Katakana",o.XK_Katakana),t("Romaji",o.XK_Romaji),t("Zenkaku",o.XK_Zenkaku),t("ZenkakuHankaku",o.XK_Zenkaku_Hankaku),t("F1",o.XK_F1),t("F2",o.XK_F2),t("F3",o.XK_F3),t("F4",o.XK_F4),t("F5",o.XK_F5),t("F6",o.XK_F6),t("F7",o.XK_F7),t("F8",o.XK_F8),t("F9",o.XK_F9),t("F10",o.XK_F10),t("F11",o.XK_F11),t("F12",o.XK_F12),t("F13",o.XK_F13),t("F14",o.XK_F14),t("F15",o.XK_F15),t("F16",o.XK_F16),t("F17",o.XK_F17),t("F18",o.XK_F18),t("F19",o.XK_F19),t("F20",o.XK_F20),t("F21",o.XK_F21),t("F22",o.XK_F22),t("F23",o.XK_F23),t("F24",o.XK_F24),t("F25",o.XK_F25),t("F26",o.XK_F26),t("F27",o.XK_F27),t("F28",o.XK_F28),t("F29",o.XK_F29),t("F30",o.XK_F30),t("F31",o.XK_F31),t("F32",o.XK_F32),t("F33",o.XK_F33),t("F34",o.XK_F34),t("F35",o.XK_F35),t("Close",o.XF86XK_Close),t("MailForward",o.XF86XK_MailForward),t("MailReply",o.XF86XK_Reply),t("MailSend",o.XF86XK_Send),t("MediaFastForward",o.XF86XK_AudioForward),t("MediaPause",o.XF86XK_AudioPause),t("MediaPlay",o.XF86XK_AudioPlay),t("MediaRecord",o.XF86XK_AudioRecord),t("MediaRewind",o.XF86XK_AudioRewind),t("MediaStop",o.XF86XK_AudioStop),t("MediaTrackNext",o.XF86XK_AudioNext),t("MediaTrackPrevious",o.XF86XK_AudioPrev),t("New",o.XF86XK_New),t("Open",o.XF86XK_Open),t("Print",o.XK_Print),t("Save",o.XF86XK_Save),t("SpellCheck",o.XF86XK_Spell),t("AudioVolumeDown",o.XF86XK_AudioLowerVolume),t("AudioVolumeUp",o.XF86XK_AudioRaiseVolume),t("AudioVolumeMute",o.XF86XK_AudioMute),t("MicrophoneVolumeMute",o.XF86XK_AudioMicMute),t("LaunchApplication1",o.XF86XK_MyComputer),t("LaunchApplication2",o.XF86XK_Calculator),t("LaunchCalendar",o.XF86XK_Calendar),t("LaunchMail",o.XF86XK_Mail),t("LaunchMediaPlayer",o.XF86XK_AudioMedia),t("LaunchMusicPlayer",o.XF86XK_Music),t("LaunchPhone",o.XF86XK_Phone),t("LaunchScreenSaver",o.XF86XK_ScreenSaver),t("LaunchSpreadsheet",o.XF86XK_Excel),t("LaunchWebBrowser",o.XF86XK_WWW),t("LaunchWebCam",o.XF86XK_WebCam),t("LaunchWordProcessor",o.XF86XK_Word),t("BrowserBack",o.XF86XK_Back),t("BrowserFavorites",o.XF86XK_Favorites),t("BrowserForward",o.XF86XK_Forward),t("BrowserHome",o.XF86XK_HomePage),t("BrowserRefresh",o.XF86XK_Refresh),t("BrowserSearch",o.XF86XK_Search),t("BrowserStop",o.XF86XK_Stop),t("Dimmer",o.XF86XK_BrightnessAdjust),t("MediaAudioTrack",o.XF86XK_AudioCycleTrack),t("RandomToggle",o.XF86XK_AudioRandomPlay),t("SplitScreenToggle",o.XF86XK_SplitScreen),t("Subtitle",o.XF86XK_Subtitle),t("VideoModeNext",o.XF86XK_Next_VMode),i("=",o.XK_equal,o.XK_KP_Equal),i("+",o.XK_plus,o.XK_KP_Add),i("-",o.XK_minus,o.XK_KP_Subtract),i("*",o.XK_asterisk,o.XK_KP_Multiply),i("/",o.XK_slash,o.XK_KP_Divide),i(".",o.XK_period,o.XK_KP_Decimal),i(",",o.XK_comma,o.XK_KP_Separator),i("0",o.XK_0,o.XK_KP_0),i("1",o.XK_1,o.XK_KP_1),i("2",o.XK_2,o.XK_KP_2),i("3",o.XK_3,o.XK_KP_3),i("4",o.XK_4,o.XK_KP_4),i("5",o.XK_5,o.XK_KP_5),i("6",o.XK_6,o.XK_KP_6),i("7",o.XK_7,o.XK_KP_7),i("8",o.XK_8,o.XK_KP_8),i("9",o.XK_9,o.XK_KP_9)})();const jt={8:"Backspace",9:"Tab",10:"NumpadClear",13:"Enter",16:"ShiftLeft",17:"ControlLeft",18:"AltLeft",19:"Pause",20:"CapsLock",21:"Lang1",25:"Lang2",27:"Escape",28:"Convert",29:"NonConvert",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",41:"Select",44:"PrintScreen",45:"Insert",46:"Delete",47:"Help",48:"Digit0",49:"Digit1",50:"Digit2",51:"Digit3",52:"Digit4",53:"Digit5",54:"Digit6",55:"Digit7",56:"Digit8",57:"Digit9",91:"MetaLeft",92:"MetaRight",93:"ContextMenu",95:"Sleep",96:"Numpad0",97:"Numpad1",98:"Numpad2",99:"Numpad3",100:"Numpad4",101:"Numpad5",102:"Numpad6",103:"Numpad7",104:"Numpad8",105:"Numpad9",106:"NumpadMultiply",107:"NumpadAdd",108:"NumpadDecimal",109:"NumpadSubtract",110:"NumpadDecimal",111:"NumpadDivide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"NumLock",145:"ScrollLock",166:"BrowserBack",167:"BrowserForward",168:"BrowserRefresh",169:"BrowserStop",170:"BrowserSearch",171:"BrowserFavorites",172:"BrowserHome",173:"AudioVolumeMute",174:"AudioVolumeDown",175:"AudioVolumeUp",176:"MediaTrackNext",177:"MediaTrackPrevious",178:"MediaStop",179:"MediaPlayPause",180:"LaunchMail",181:"MediaSelect",182:"LaunchApp1",183:"LaunchApp2",225:"AltRight"},Jt={Backspace:"Backspace",AltLeft:"Alt",AltRight:"Alt",CapsLock:"CapsLock",ContextMenu:"ContextMenu",ControlLeft:"Control",ControlRight:"Control",Enter:"Enter",MetaLeft:"Meta",MetaRight:"Meta",ShiftLeft:"Shift",ShiftRight:"Shift",Tab:"Tab",Delete:"Delete",End:"End",Help:"Help",Home:"Home",Insert:"Insert",PageDown:"PageDown",PageUp:"PageUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",ArrowUp:"ArrowUp",NumLock:"NumLock",NumpadBackspace:"Backspace",NumpadClear:"Clear",Escape:"Escape",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",F13:"F13",F14:"F14",F15:"F15",F16:"F16",F17:"F17",F18:"F18",F19:"F19",F20:"F20",F21:"F21",F22:"F22",F23:"F23",F24:"F24",F25:"F25",F26:"F26",F27:"F27",F28:"F28",F29:"F29",F30:"F30",F31:"F31",F32:"F32",F33:"F33",F34:"F34",F35:"F35",PrintScreen:"PrintScreen",ScrollLock:"ScrollLock",Pause:"Pause",BrowserBack:"BrowserBack",BrowserFavorites:"BrowserFavorites",BrowserForward:"BrowserForward",BrowserHome:"BrowserHome",BrowserRefresh:"BrowserRefresh",BrowserSearch:"BrowserSearch",BrowserStop:"BrowserStop",Eject:"Eject",LaunchApp1:"LaunchMyComputer",LaunchApp2:"LaunchCalendar",LaunchMail:"LaunchMail",MediaPlayPause:"MediaPlay",MediaStop:"MediaStop",MediaTrackNext:"MediaTrackNext",MediaTrackPrevious:"MediaTrackPrevious",Power:"Power",Sleep:"Sleep",AudioVolumeDown:"AudioVolumeDown",AudioVolumeMute:"AudioVolumeMute",AudioVolumeUp:"AudioVolumeUp",WakeUp:"WakeUp"},Q={isMac:function(){return/Mac|iPod|iPhone|iPad/.test(navigator.platform)},isIOS:function(){return/iPod|iPhone|iPad/.test(navigator.platform)},isWindows:function(){return/Win/.test(navigator.platform)},isLinux:function(){return/Linux/.test(navigator.platform)},isChrome:function(){return!!window.chrome&&(!!window.chrome.webstore||!!window.chrome.runtime)},isSafari:function(){return/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)}},Qt={[o.XK_KP_Space]:o.XK_space,[o.XK_KP_Enter]:o.XK_Return,[o.XK_KP_Equal]:o.XK_equal,[o.XK_KP_Multiply]:o.XK_asterisk,[o.XK_KP_Add]:o.XK_plus,[o.XK_KP_Separator]:o.XK_comma,[o.XK_KP_Subtract]:o.XK_minus,[o.XK_KP_Decimal]:o.XK_period,[o.XK_KP_Divide]:o.XK_slash,[o.XK_KP_0]:o.XK_0,[o.XK_KP_1]:o.XK_1,[o.XK_KP_2]:o.XK_2,[o.XK_KP_3]:o.XK_3,[o.XK_KP_4]:o.XK_4,[o.XK_KP_5]:o.XK_5,[o.XK_KP_6]:o.XK_6,[o.XK_KP_7]:o.XK_7,[o.XK_KP_8]:o.XK_8,[o.XK_KP_9]:o.XK_9},Zt={[o.XK_KP_Home]:o.XK_Home,[o.XK_KP_Up]:o.XK_Up,[o.XK_KP_Page_Up]:o.XK_Page_Up,[o.XK_KP_Prior]:o.XK_Prior,[o.XK_KP_Left]:o.XK_Left,[o.XK_KP_Begin]:o.XK_Clear,[o.XK_KP_Right]:o.XK_Right,[o.XK_KP_End]:o.XK_End,[o.XK_KP_Down]:o.XK_Down,[o.XK_KP_Page_Down]:o.XK_Page_Down,[o.XK_KP_Next]:o.XK_Next,[o.XK_KP_Insert]:o.XK_Insert,[o.XK_KP_Delete]:o.XK_Delete,[o.XK_KP_Enter]:o.XK_Return},ae={getKeyCode:function(t){if(t.code){switch(t.code){case"OSLeft":return"MetaLeft";case"OSRight":return"MetaRight"}return t.code}if(t.keyCode in jt){let e=jt[t.keyCode];if(Q.isMac()&&e==="ContextMenu"&&(e="MetaRight"),t.location===2)switch(e){case"ShiftLeft":return"ShiftRight";case"ControlLeft":return"ControlRight";case"AltLeft":return"AltRight"}if(t.location===3)switch(e){case"Delete":return"NumpadDecimal";case"Insert":return"Numpad0";case"End":return"Numpad1";case"ArrowDown":return"Numpad2";case"PageDown":return"Numpad3";case"ArrowLeft":return"Numpad4";case"ArrowRight":return"Numpad6";case"Home":return"Numpad7";case"ArrowUp":return"Numpad8";case"PageUp":return"Numpad9";case"Enter":return"NumpadEnter"}return e}return"Unidentified"},getKey:function(t){if(t.key!==void 0&&t.key!=="Unidentified"&&t.key!=="Dead"){switch(t.key){case"OS":return"Meta";case"LaunchMyComputer":return"LaunchApplication1";case"LaunchCalculator":return"LaunchApplication2";case"UIKeyInputUpArrow":return"ArrowUp";case"UIKeyInputDownArrow":return"ArrowDown";case"UIKeyInputLeftArrow":return"ArrowLeft";case"UIKeyInputRightArrow":return"ArrowRight";case"UIKeyInputEscape":return"Escape"}return t.key==="\0"&&ae.getKeyCode(t)==="NumpadDecimal"?"Delete":t.key}const e=ae.getKeyCode(t);return e in Jt?Jt[e]:t.charCode?String.fromCharCode(t.charCode):"Unidentified"},getKeysym:function(t){const e=ae.getKey(t);if(e==="Unidentified")return null;if(e in Se){let s=t.location;if((Q.isSafari()&&e==="Meta"&&s===0||Q.isChrome()&&e==="Meta"&&s===0&&ae.getKeyCode(t)==="MetaRight")&&(s=2),e==="Clear"&&s===3&&ae.getKeyCode(t)==="NumLock"&&(s=0),(s===void 0||s>3)&&(s=0),e==="Meta"){let n=ae.getKeyCode(t);if(n==="AltLeft")return o.XK_Meta_L;if(n==="AltRight")return o.XK_Meta_R}if(e==="Clear"&&ae.getKeyCode(t)==="NumLock")return o.XK_Num_Lock;if(Q.isWindows())switch(e){case"Zenkaku":case"Hankaku":return o.XK_Zenkaku_Hankaku;case"Romaji":case"KanaMode":return o.XK_Romaji}return Se[e][s]}if(e.length!==1)return null;const i=e.charCodeAt();return i?Ye.lookup(i):null}},he=function(t){t.stopPropagation(),t.preventDefault()};class Bt{constructor(e,i,s=!1,n=0,l=!1,c=null){this.element=e,this.send=i,this._isSidebarOpen=!1,this.isSharedMode=s,this.controllerSlot=c,this.playerIndex=n,this.cursorDiv=document.createElement("canvas"),this.cursorDiv.style.position="fixed",this.cursorDiv.style.pointerEvents="none",this.cursorDiv.style.zIndex="999999",this.cursorDiv.style.display="none",this.cursorDiv.style.left="0px",this.cursorDiv.style.top="0px",this.cursorImg=this.cursorDiv.getContext("2d"),document.body.appendChild(this.cursorDiv),this.cursorHotspot={x:0,y:0},this._cursorImageBitmap=null,this._rawHotspotX=0,this._rawHotspotY=0,this.use_browser_cursors=!1,this._latestMouseX=0,this._latestMouseY=0,this.useCssScaling=l,this.mouseRelative=!1,this.m=null,this.buttonMask=0,this.gamepadManager=null,this.x=0,this.y=0,this.onmenuhotkey=null,this.onfullscreenhotkey=this.enterFullscreen,this.ongamepadconnected=null,this.ongamepaddisconneceted=null,this.listeners=[],this.listeners_context=[],this._queue=new xi,this._allowTrackpadScrolling=!0,this._allowThreshold=!0,this._smallestDeltaY=1e4,this._wheelThreshold=100,this._scrollMagnitude=10,this.cursorScaleFactor=null,this._cursorBase64Data=null,this._guacKeyboardID=Bt._nextGuacID++,this._EVENT_MARKER="_GUAC_KEYBOARD_HANDLED_BY_"+this._guacKeyboardID,this._keyDownList={},this._altGrArmed=!1,this._altGrTimeout=null,this._altGrCtrlTime=0,this._macCmdSwapped=!1,this._isSynth=!1,this.isComposing=!1,this.compositionString="",this.keyboardInputAssist=document.getElementById("keyboard-input-assist"),this._activeTouches=new Map,this._activeTouchIdentifier=null,this._isTwoFingerGesture=!1,this._MIN_SWIPE_DISTANCE=30,this._MAX_SWIPE_DURATION=600,this._VERTICAL_SWIPE_RATIO=1.5,this._SCROLL_PIXELS_PER_TICK=40,this._MAX_SCROLL_MAGNITUDE=8,this._TAP_THRESHOLD_DISTANCE_SQ=100,this._TAP_MAX_DURATION=250,this._trackpadMode=!1,this._trackpadTouches=new Map,this._trackpadLastTapTime=0,this._trackpadIsDragging=!1,this._trackpadTapTimeout=null,this._trackpadLastScrollCentroid=null,this._touchScrollLastCentroid=null,this.inputAttached=!1}setSharedMode(e){this.isSharedMode=!!e}updateControllerSlot(e){this.controllerSlot!==e&&(console.log(`Input class: Controller slot updated to: ${e}`),this.controllerSlot=e)}_handleVisibilityMessage(e){if(e.origin!==window.location.origin)return;const i=e.data;typeof i=="object"&&i!==null&&i.type==="sidebarVisibilityChanged"&&(this._isSidebarOpen=!!i.isOpen)}static _nextGuacID=0;_drawAndScaleCursor(){if(!this._cursorImageBitmap)return;const e=this.useCssScaling?1:window.devicePixelRatio||1,i=this._cursorImageBitmap;this.cursorDiv.width=i.width,this.cursorDiv.height=i.height,this.cursorDiv.style.width=`${i.width/e}px`,this.cursorDiv.style.height=`${i.height/e}px`,this.cursorImg.clearRect(0,0,i.width,i.height),this.cursorImg.drawImage(i,0,0),this.cursorHotspot.x=this._rawHotspotX/e,this.cursorHotspot.y=this._rawHotspotY/e,this._updateCursorPosition(this._latestMouseX,this._latestMouseY)}_handleOutsideClick(e){!this.use_browser_cursors&&!this.element.contains(e.target)&&(this.cursorDiv.style.display="none")}_updateCursorPosition(e,i){if(this.cursorDiv.style.display!=="none"){const s=e-this.cursorHotspot.x,n=i-this.cursorHotspot.y;this.cursorDiv.style.transform=`translate(${s}px, ${n}px)`}}_updateBrowserCursor(){if(!this._cursorBase64Data){this.element.style.setProperty("cursor","none","important");return}const e=`data:image/png;base64,${this._cursorBase64Data}`;this.element.style.setProperty("cursor",`url("${e}") ${this._rawHotspotX} ${this._rawHotspotY}, default`,"important")}async updateServerCursor(e){if(!e.curdata||parseInt(e.handle,10)===0||this._trackpadMode){this._cursorImageBitmap=null,this._cursorBase64Data=null,this.cursorDiv.style.display="none",this.use_browser_cursors&&this.element.style.setProperty("cursor","none","important");return}if(this._rawHotspotX=parseInt(e.hotx)||0,this._rawHotspotY=parseInt(e.hoty)||0,this._cursorBase64Data=e.curdata,!this.inputAttached){this.cursorDiv.style.display="none",this.element.style.cursor="auto";return}if(this.use_browser_cursors)this.cursorDiv.style.display="none",this._updateBrowserCursor();else{const i=await(await fetch(`data:image/png;base64,${this._cursorBase64Data}`)).blob();this._cursorImageBitmap=await createImageBitmap(i),this.element.style.setProperty("cursor","none","important"),this.cursorDiv.style.display="block",this._drawAndScaleCursor()}}setSynth(e){console.log(`Input: Synthetic mode ${e?"enabled":"disabled"}.`),this._isSynth=e}updateCssScaling(e){this.useCssScaling!==e&&(console.log(`Input: Updating useCssScaling from ${this.useCssScaling} to ${e}`),this.useCssScaling=e,this._windowMath(),this._drawAndScaleCursor())}_sendKeyEvent(e,i,s){if(e===null)return;let n=e;if(Qt.hasOwnProperty(e)?n=Qt[e]:Zt.hasOwnProperty(e)&&(n=Zt[e]),s)this._keyDownList[i]=n;else{if(!(i in this._keyDownList))return;n=this._keyDownList[i],delete this._keyDownList[i]}this.send((s?"kd,":"ku,")+n)}resetKeyboard(){for(const e in this._keyDownList)this._sendKeyEvent(this._keyDownList[e],e,!1);this._keyDownList={}}_guac_markEvent(e){return e[this._EVENT_MARKER]?!1:(e[this._EVENT_MARKER]=!0,!0)}_handleKeyDown(e){if(this._targetHasClass(e.target,He)||!this._guac_markEvent(e))return;if(ae.getKeyCode(e)in this._keyDownList){he(e);return}if(this.isComposing||e.isComposing||e.keyCode===229){he(e);return}if(!this._isSynth)for(const c in this._keyDownList){const p=this._keyDownList[c];(c==="ControlLeft"||c==="ControlRight")&&!e.ctrlKey&&this._sendKeyEvent(p,c,!1),(c==="MetaLeft"||c==="MetaRight")&&!e.metaKey&&this._sendKeyEvent(p,c,!1),(c==="AltLeft"||c==="AltRight")&&!e.altKey&&this._sendKeyEvent(p,c,!1),(c==="ShiftLeft"||c==="ShiftRight")&&!e.shiftKey&&this._sendKeyEvent(p,c,!1)}if(e.code==="KeyM"&&e.ctrlKey&&e.shiftKey&&document.fullscreenElement===null&&this.onmenuhotkey!==null){this.onmenuhotkey(),he(e);return}if(e.code==="KeyF"&&e.ctrlKey&&e.shiftKey&&document.fullscreenElement===null&&this.onfullscreenhotkey!==null){this.onfullscreenhotkey(),he(e);return}const s=ae.getKeyCode(e);let n=ae.getKeysym(e);if(this._altGrArmed&&(this._altGrArmed=!1,clearTimeout(this._altGrTimeout),s==="AltRight"&&e.timeStamp-this._altGrCtrlTime<50?n=o.XK_ISO_Level3_Shift:this._sendKeyEvent(o.XK_Control_L,"ControlLeft",!0)),s==="Unidentified"&&n){this._sendKeyEvent(n,s,!0),this._sendKeyEvent(n,s,!1),he(e);return}if(Q.isMac()&&s!=="MetaLeft"&&s!=="MetaRight"&&e.metaKey&&!e.ctrlKey&&!e.altKey&&(this._keyDownList.MetaLeft||this._keyDownList.MetaRight)&&(console.log(`macOS: Cmd+key detected for code '${s}'. Remapping Cmd to Ctrl.`),this._keyDownList.MetaLeft&&this._sendKeyEvent(this._keyDownList.MetaLeft,"MetaLeft",!1),this._keyDownList.MetaRight&&this._sendKeyEvent(this._keyDownList.MetaRight,"MetaRight",!1),this._sendKeyEvent(o.XK_Control_L,"ControlLeft",!0),this._macCmdSwapped=!0),Q.isMac()||Q.isIOS())switch(n){case o.XK_Super_L:n=o.XK_Alt_L;break;case o.XK_Super_R:n=o.XK_Super_L;break;case o.XK_Alt_L:n=o.XK_Mode_switch;break;case o.XK_Alt_R:n=o.XK_ISO_Level3_Shift;break}if(s in this._keyDownList&&(n=this._keyDownList[s]),(Q.isMac()||Q.isIOS())&&s==="CapsLock"){this._sendKeyEvent(o.XK_Caps_Lock,"CapsLock",!0),this._sendKeyEvent(o.XK_Caps_Lock,"CapsLock",!1),he(e);return}const l=[o.XK_Zenkaku_Hankaku,o.XK_Eisu_toggle,o.XK_Katakana,o.XK_Hiragana,o.XK_Romaji];if(Q.isWindows()&&l.includes(n)){this._sendKeyEvent(n,s,!0),this._sendKeyEvent(n,s,!1),he(e);return}if(he(e),s==="ControlLeft"&&Q.isWindows()&&!(s in this._keyDownList)){this._altGrArmed=!0,this._altGrCtrlTime=e.timeStamp,this._altGrTimeout=setTimeout(()=>{this._altGrArmed=!1,this._sendKeyEvent(o.XK_Control_L,"ControlLeft",!0)},100);return}this._sendKeyEvent(n,s,!0)}_handleKeyPress(e){this._targetHasClass(e.target,He)||this._guac_markEvent(e)}_handleKeyUp(e){if(this._targetHasClass(e.target,He)||!this._guac_markEvent(e))return;he(e);const i=ae.getKeyCode(e);if(Q.isMac()&&(i==="MetaLeft"||i==="MetaRight")){console.log(`macOS: Command key ('${i}') released. Cleaning up potentially stuck keys.`);const n=Object.keys(this._keyDownList);for(const l of n)l==="ShiftLeft"||l==="ShiftRight"||l==="ControlLeft"||l==="ControlRight"||l==="AltLeft"||l==="AltRight"||l==="MetaLeft"||l==="MetaRight"||(console.log(`macOS: Force-releasing stuck key: ${l}`),this._sendKeyEvent(this._keyDownList[l],l,!1));this._macCmdSwapped&&(console.log("macOS: Releasing the swapped virtual Ctrl key."),"ControlLeft"in this._keyDownList&&this._sendKeyEvent(this._keyDownList.ControlLeft,"ControlLeft",!1),this._macCmdSwapped=!1)}if(this._altGrArmed&&(this._altGrArmed=!1,clearTimeout(this._altGrTimeout),this._sendKeyEvent(o.XK_Control_L,"ControlLeft",!0)),(Q.isMac()||Q.isIOS())&&i==="CapsLock")return;const s=this._keyDownList[i];this._sendKeyEvent(s,i,!1),Q.isWindows()&&(i==="ShiftLeft"||i==="ShiftRight")&&("ShiftRight"in this._keyDownList&&this._sendKeyEvent(this._keyDownList.ShiftRight,"ShiftRight",!1),"ShiftLeft"in this._keyDownList&&this._sendKeyEvent(this._keyDownList.ShiftLeft,"ShiftLeft",!1))}_updateCompositionText(e){const i=this.compositionString,s=e||"";let n=0;for(;n<i.length&&n<s.length&&i[n]===s[n];)n++;const l=i.length-n;for(let p=0;p<l;p++)this._sendKeyEvent(o.XK_BackSpace,"Backspace",!0),this._sendKeyEvent(o.XK_BackSpace,"Backspace",!1);const c=s.substring(n);for(let p=0;p<c.length;p++){const h=Ye.lookup(c.charCodeAt(p));h&&(this._sendKeyEvent(h,"Unidentified",!0),this._sendKeyEvent(h,"Unidentified",!1))}this.compositionString=s}_compositionStart(e){this._guac_markEvent(e)&&(this.isComposing=!0,this.compositionString="")}_compositionUpdate(e){this._guac_markEvent(e)&&this.isComposing&&this._updateCompositionText(e.data)}_compositionEnd(e){if(this._guac_markEvent(e)&&this.isComposing){if(Q.isLinux()){this._updateCompositionText(""),this.isComposing=!1,this.compositionString="";return}this._updateCompositionText(e.data),this.isComposing=!1,this.compositionString=""}}_handleTextInput(e){if(!e.data)return;const i=e.data;for(let s=0;s<i.length;s++){const n=i.charCodeAt(s),l=Ye.lookup(n);l&&(this._sendKeyEvent(l,"Unidentified",!0),this._sendKeyEvent(l,"Unidentified",!1))}}_handleMobileInput(e){const i=e.target.value;if(i){for(let s=0;s<i.length;s++){const n=i[s];if(n>="A"&&n<="Z"){this.send("kd,"+o.XK_Shift_L);const c=n.toLowerCase(),p=Ye.lookup(c.charCodeAt(0));p&&(this.send("kd,"+p),this.send("ku,"+p)),this.send("ku,"+o.XK_Shift_L)}else{const c=Ye.lookup(n.charCodeAt(0));c&&(this.send("kd,"+c),this.send("ku,"+c))}}e.target.value=""}}_mouseButtonMovement(e){if(this.buttonMask===0&&e.target!==this.element)return;this.inputAttached&&!this.use_browser_cursors&&(this.cursorDiv.style.display="block",this.element.style.setProperty("cursor","none","important"));let i=e.clientX,s=e.clientY;if(e.getPredictedEvents&&typeof e.getPredictedEvents=="function"){const r=e.getPredictedEvents();if(r.length>0){const a=r[r.length-1];i=a.clientX,s=a.clientY}}if(this.inputAttached&&!this.use_browser_cursors&&this._updateCursorPosition(i,s),this._latestMouseX=i,this._latestMouseY=s,this._trackpadMode)return;const n=window.devicePixelRatio||1,l=this.useCssScaling?1:n,c=e.type==="mousedown"||e.type==="pointerdown"?1:0;var p="m";let h=document.getElementById("videoCanvas");if((e.type==="mousedown"||e.type==="mouseup"||e.type==="pointerdown"||e.type==="pointerup"||e.type==="pointercancel")&&(e.button===3||e.button===4)&&e.preventDefault(),c&&e.button===0&&e.ctrlKey&&e.shiftKey){(e.target.requestPointerLock?e.target:this.element).requestPointerLock().catch(a=>console.error("Pointer lock failed:",a)),e.preventDefault();return}if(document.pointerLockElement===this.element||document.pointerLockElement===h){p="m2";let r=e.movementX||0,a=e.movementY||0;this.x=Math.round(r*l),this.y=Math.round(a*l)}else if(e.type==="mousemove"||e.type==="pointermove")if((window.is_manual_resolution_mode||this.isSharedMode)&&h){const r=h.getBoundingClientRect();if(r.width>0&&r.height>0&&h.width>0&&h.height>0){const a=e.clientX-r.left,u=e.clientY-r.top,f=h.width/r.width,_=h.height/r.height;let w=a*f,K=u*_;this.x=Math.max(0,Math.min(h.width,Math.round(w))),this.y=Math.max(0,Math.min(h.height,Math.round(K)))}else this.x=0,this.y=0}else if(this.m||this._windowMath(),this.m){let r=this._clientToServerX(e.clientX),a=this._clientToServerY(e.clientY);this.x=Math.round(r*l),this.y=Math.round(a*l)}else this.x=0,this.y=0;if(e.type==="mousedown"||e.type==="mouseup"){var b=1<<e.button;c?this.buttonMask|=b:this.buttonMask&=~b}var S=[p,this.x,this.y,this.buttonMask,0];this.send(S.join(","))}_handlePointerDown(e){e.pointerType==="pen"&&(e.preventDefault(),this._mouseButtonMovement(e))}_handlePointerMove(e){e.pointerType==="pen"&&this._mouseButtonMovement(e)}_handlePointerUp(e){e.pointerType==="pen"&&this._mouseButtonMovement(e)}_handleTrackpadEvent(e){if(this._targetHasClass(e.target,He))return;e.preventDefault(),e.stopPropagation();const i=Date.now(),s=this.useCssScaling?1:window.devicePixelRatio||1,n=300,l=e.type,c=e.changedTouches;if(l==="touchstart"){this._trackpadTapTimeout&&(clearTimeout(this._trackpadTapTimeout),this._trackpadTapTimeout=null);for(const h of c)this._trackpadTouches.set(h.identifier,{id:h.identifier,startX:h.clientX,startY:h.clientY,lastX:h.clientX,lastY:h.clientY,moved:!1});const p=this._trackpadTouches.size;if(p===1)i-this._trackpadLastTapTime<n?(this._trackpadGestureMode="dragging",this.buttonMask|=1,this.send(`m2,0,0,${this.buttonMask},0`),this._trackpadLastTapTime=0):this._trackpadGestureMode="moving";else if(p===2){this._trackpadGestureMode="scrolling",this._trackpadLastTapTime=0;const h=Array.from(this._trackpadTouches.values());this._trackpadLastScrollCentroid={x:(h[0].lastX+h[1].lastX)/2,y:(h[0].lastY+h[1].lastY)/2}}}else if(l==="touchmove"){let p=!1;for(const h of this._trackpadTouches.values()){if(!h.moved){const b=Array.from(c).find(S=>S.identifier===h.id)||h;if(b){const S=b.clientX-h.startX,r=b.clientY-h.startY;S*S+r*r>this._TAP_THRESHOLD_DISTANCE_SQ&&(h.moved=!0)}}h.moved&&(p=!0)}if(p&&(this._trackpadLastTapTime=0),this._trackpadGestureMode==="moving"||this._trackpadGestureMode==="dragging"){const h=this._trackpadTouches.values().next().value;if(h){const b=Array.from(c).find(S=>S.identifier===h.id);if(b){const S=(b.clientX-h.lastX)*s,r=(b.clientY-h.lastY)*s;(Math.abs(S)>=.5||Math.abs(r)>=.5)&&this.send(`m2,${Math.round(S)},${Math.round(r)},${this.buttonMask},0`),h.lastX=b.clientX,h.lastY=b.clientY}}}else if(this._trackpadGestureMode==="scrolling"){const h=Array.from(this._trackpadTouches.values());if(h.length===2){for(const r of c){const a=this._trackpadTouches.get(r.identifier);a&&(a.lastX=r.clientX,a.lastY=r.clientY)}const b=(h[0].lastX+h[1].lastX)/2,S=(h[0].lastY+h[1].lastY)/2;if(this._trackpadLastScrollCentroid){const r=b-this._trackpadLastScrollCentroid.x,a=S-this._trackpadLastScrollCentroid.y,u=2;Math.abs(a)>u&&this._triggerMouseWheel(a<0?"down":"up",1),Math.abs(r)>u&&this._triggerHorizontalMouseWheel(r<0?"left":"right",1)}this._trackpadLastScrollCentroid={x:b,y:S}}}}else if(l==="touchend"||l==="touchcancel"){const p=this._trackpadTouches.size,h=!Array.from(this._trackpadTouches.values()).some(b=>b.moved);p===2&&h?(this.buttonMask|=4,this.send(`m2,0,0,${this.buttonMask},0`),setTimeout(()=>{this.buttonMask&=-5,this.send(`m2,0,0,${this.buttonMask},0`)},50),this._trackpadGestureMode="completed",this._trackpadLastTapTime=0):p===1&&h&&this._trackpadGestureMode!=="completed"&&this._trackpadGestureMode!=="dragging"&&(this._trackpadLastTapTime=i,this._trackpadTapTimeout=setTimeout(()=>{this.buttonMask|=1,this.send(`m2,0,0,${this.buttonMask},0`),setTimeout(()=>{this.buttonMask&=-2,this.send(`m2,0,0,${this.buttonMask},0`)},50)},200));for(const b of c)this._trackpadTouches.delete(b.identifier);this._trackpadTouches.size===0&&(this._trackpadGestureMode==="dragging"&&(this.buttonMask&=-2,this.send(`m2,0,0,${this.buttonMask},0`)),this._trackpadGestureMode=null,this._trackpadLastScrollCentroid=null)}}_calculateTouchCoordinates(e){this._updateCursorPosition(e.clientX,e.clientY),this._latestMouseX=e.clientX,this._latestMouseY=e.clientY;const i=window.devicePixelRatio||1,s=this.useCssScaling?1:i;let n=document.getElementById("videoCanvas");if((window.is_manual_resolution_mode||this.isSharedMode)&&n){const l=n.getBoundingClientRect();if(l.width>0&&l.height>0&&n.width>0&&n.height>0){const c=e.clientX-l.left,p=e.clientY-l.top,h=n.width/l.width,b=n.height/l.height;let S=c*h,r=p*b;this.x=Math.max(0,Math.min(n.width,Math.round(S))),this.y=Math.max(0,Math.min(n.height,Math.round(r)))}else this.x=0,this.y=0}else if(this.m||this._windowMath(),this.m){let l=this._clientToServerX(e.clientX),c=this._clientToServerY(e.clientY);this.x=Math.round(l*s),this.y=Math.round(c*s)}else this.x=Math.round(e.clientX*s),this.y=Math.round(e.clientY*s)}_sendMouseState(){const i=[document.pointerLockElement===this.element||this.mouseRelative?"m2":"m",this.x,this.y,this.buttonMask,0];this.send(i.join(","))}setTrackpadMode(e){const i=!!e;this._trackpadMode!==i&&(console.log(`Input: Trackpad mode ${i?"enabled":"disabled"}.`),this._trackpadMode=i,this._activeTouches.clear(),this._activeTouchIdentifier=null,this._isTwoFingerGesture=!1,this._touchScrollLastCentroid=null,this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null,this._longPressTouchIdentifier=null),this.buttonMask!==0&&(this.buttonMask=0,this._sendMouseState()),this._trackpadMode||this.use_browser_cursors?(this.element.style.setProperty("cursor","none","important"),this.element.style.cursor="default"):(this.element.style.setProperty("cursor","none","important"),this.cursorDiv.style.display="none"))}async setUseBrowserCursors(e){const i=!!e;if(this.use_browser_cursors!==i)if(console.log(`Input: Use browser cursors ${i?"enabled":"disabled"}.`),this.use_browser_cursors=i,this._trackpadMode)this.cursorDiv.style.display="none",this.element.style.setProperty("cursor","none","important");else if(this.use_browser_cursors)this.cursorDiv.style.display="none",this._updateBrowserCursor();else{if(this.element.style.setProperty("cursor","none","important"),this._cursorBase64Data&&!this._cursorImageBitmap){const s=await(await fetch(`data:image/png;base64,${this._cursorBase64Data}`)).blob();this._cursorImageBitmap=await createImageBitmap(s)}this._cursorImageBitmap?(this.cursorDiv.style.display="block",this._drawAndScaleCursor()):this.cursorDiv.style.display="none"}}_handleTouchEvent(e){if(this._trackpadMode){this._handleTrackpadEvent(e);return}if(this._targetHasClass(e.target,He)||!this._guac_markEvent(e))return;const i=e.type,s=Date.now();let n=!1;const l=750;let c=!1;const p=225,h=this._TAP_THRESHOLD_DISTANCE_SQ;if(i==="touchstart"){this.use_browser_cursors||(this.cursorDiv.style.display="block");for(let S=0;S<e.changedTouches.length;S++){const r=e.changedTouches[S];this._activeTouches.has(r.identifier)||(this._activeTouches.set(r.identifier,{startX:r.clientX,startY:r.clientY,currentX:r.clientX,currentY:r.clientY,startTime:s,identifier:r.identifier,longPressCompleted:!1}),S===0&&this._calculateTouchCoordinates(r))}const b=this._activeTouches.size;if(b===1&&!this._isTwoFingerGesture){n=!0;const[S]=this._activeTouches.keys(),r=this._activeTouches.get(S),a={clientX:r.currentX,clientY:r.currentY};this._calculateTouchCoordinates(a);const u=this.x,f=this.y;r&&!r.longPressCompleted&&(this._longPressTouchIdentifier=S,this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=setTimeout(()=>{const _=this._activeTouches.get(this._longPressTouchIdentifier);if(_&&this._activeTouches.size===1&&this._longPressTouchIdentifier===_.identifier&&!this._isTwoFingerGesture&&this._activeTouchIdentifier===null&&!_.longPressCompleted){const w=_.currentX-_.startX,K=_.currentY-_.startY;w*w+K*K<p&&(_.longPressCompleted=!0,this.x=u,this.y=f,this.buttonMask|=4,this._sendMouseState(),setTimeout(()=>{(this.buttonMask&4)!==0&&(this.buttonMask&=-5,this._sendMouseState())},50))}this._longPressTimer=null},l))}else{if(this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null),b===2){this.use_browser_cursors||(this.cursorDiv.style.visibility="hidden"),this._isTwoFingerGesture=!0,this._activeTouchIdentifier=null;const S=Array.from(this._activeTouches.values());this._touchScrollLastCentroid={x:(S[0].currentX+S[1].currentX)/2,y:(S[0].currentY+S[1].currentY)/2},(this.buttonMask&1)===1&&(this.buttonMask&=-2),n=!0}else b>2&&(this._isTwoFingerGesture&&(this._isTwoFingerGesture=!1),this._activeTouchIdentifier!==null&&(this.buttonMask&=-2,this._sendMouseState(),this._activeTouchIdentifier=null));b!==1&&(this._longPressTouchIdentifier=null)}}else if(i==="touchmove")for(let b=0;b<e.changedTouches.length;b++){const S=e.changedTouches[b],r=this._activeTouches.get(S.identifier);if(r&&(r.currentX=S.clientX,r.currentY=S.clientY,this._longPressTimer&&S.identifier===this._longPressTouchIdentifier)){const a=r.currentX-r.startX,u=r.currentY-r.startY;a*a+u*u>=p&&(clearTimeout(this._longPressTimer),this._longPressTimer=null)}}if(this._isTwoFingerGesture&&this._activeTouches.size===2){n=!0;const b=Array.from(this._activeTouches.values()),S=(b[0].currentX+b[1].currentX)/2,r=(b[0].currentY+b[1].currentY)/2;if(this._touchScrollLastCentroid){const a=S-this._touchScrollLastCentroid.x,u=r-this._touchScrollLastCentroid.y,f=2;Math.abs(u)>f&&this._triggerMouseWheel(u<0?"down":"up",1),Math.abs(a)>f&&this._triggerHorizontalMouseWheel(a<0?"left":"right",1)}this._touchScrollLastCentroid={x:S,y:r}}else if(this._activeTouches.size===1){const[b]=this._activeTouches.keys(),S=this._activeTouches.get(b);if(this._activeTouchIdentifier===b)this._calculateTouchCoordinates({clientX:S.currentX,clientY:S.currentY}),this._sendMouseState(),c=!0,n=!0;else if(this._activeTouchIdentifier===null&&!S.longPressCompleted){const r=S.currentX-S.startX,a=S.currentY-S.startY;r*r+a*a>=h&&(this._longPressTimer&&b===this._longPressTouchIdentifier&&(clearTimeout(this._longPressTimer),this._longPressTimer=null),this._activeTouchIdentifier=b,this._calculateTouchCoordinates({clientX:S.currentX,clientY:S.currentY}),this.buttonMask|=1,this._sendMouseState(),c=!0),n=!0}}if(this._activeTouchIdentifier!==null&&!c&&this._activeTouches.size>0)n=!0;else if(i==="touchend"||i==="touchcancel"){const b=e.changedTouches;for(let S=0;S<b.length;S++){const r=b[S],a=r.identifier,u=this._activeTouches.get(a);if(!u)continue;if(this._longPressTimer&&a===this._longPressTouchIdentifier&&(clearTimeout(this._longPressTimer),this._longPressTimer=null),u.longPressCompleted){this._activeTouches.delete(a),a===this._longPressTouchIdentifier&&(this._longPressTouchIdentifier=null),n=!0;continue}u.currentX=r.clientX,u.currentY=r.clientY;const f=s-u.startTime,_=u.currentX-u.startX,w=u.currentY-u.startY,K=_*_+w*w;this._isTwoFingerGesture||(this._activeTouchIdentifier===null&&this._activeTouches.size===1&&this._activeTouches.has(a)?f<this._TAP_MAX_DURATION&&K<h&&(this._calculateTouchCoordinates(r),this.buttonMask|=1,this._sendMouseState(),n=!0,setTimeout(()=>{this.buttonMask&=-2,this._sendMouseState()},10)):a===this._activeTouchIdentifier&&(this._calculateTouchCoordinates(r),this.buttonMask&=-2,this._sendMouseState(),this._activeTouchIdentifier=null,n=!0)),this._activeTouches.delete(a),a===this._longPressTouchIdentifier&&(this._longPressTouchIdentifier=null)}{const S=this._activeTouches.size;if(this._isTwoFingerGesture&&S<2&&(!this._trackpadMode&&!this.use_browser_cursors&&(this.cursorDiv.style.visibility="visible"),this._isTwoFingerGesture=!1,this._touchScrollLastCentroid=null),S===0&&(this._activeTouchIdentifier=null,this._isTwoFingerGesture=!1,this._touchScrollLastCentroid=null,this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null),this._longPressTouchIdentifier=null),S>0&&this._longPressTouchIdentifier&&!this._activeTouches.has(this._longPressTouchIdentifier)&&(this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=null,this._longPressTouchIdentifier=null),S===1){const[r]=this._activeTouches.keys();if(this._longPressTouchIdentifier!==r){this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=null,this._longPressTouchIdentifier=null;const a=this._activeTouches.get(r);if(a&&!a.longPressCompleted){const u={clientX:a.currentX,clientY:a.currentY,identifier:r};this._calculateTouchCoordinates(u);const f=this.x,_=this.y;this._longPressTouchIdentifier=r,this._longPressTimer=setTimeout(()=>{const w=this._activeTouches.get(this._longPressTouchIdentifier);if(w&&this._activeTouches.size===1&&this._longPressTouchIdentifier===w.identifier&&!this._isTwoFingerGesture&&this._activeTouchIdentifier===null&&!w.longPressCompleted){const K=w.currentX-w.startX,X=w.currentY-w.startY;K*K+X*X<p&&(w.longPressCompleted=!0,this.x=f,this.y=_,this.buttonMask|=4,this._sendMouseState(),setTimeout(()=>{(this.buttonMask&4)!==0&&(this.buttonMask&=-5,this._sendMouseState())},50))}this._longPressTimer=null},l)}}}else S!==1&&(this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=null,this._longPressTouchIdentifier=null)}}n&&this.element.contains(e.target)&&e.preventDefault()}_triggerMouseWheel(e,i){i=Math.max(1,Math.round(i));const n=1<<(e==="up"?4:3),l="m2",c=0,p=0;this.buttonMask|=n,this.send([l,c,p,this.buttonMask,i].join(",")),setTimeout(()=>{(this.buttonMask&n)!==0&&(this.buttonMask&=~n,this.send([l,c,p,this.buttonMask,i].join(",")))},10)}_triggerHorizontalMouseWheel(e,i){i=Math.max(1,Math.round(i));const n=1<<(e==="left"?6:7),l="m2",c=0,p=0;this.buttonMask|=n,this.send([l,c,p,this.buttonMask,i].join(",")),setTimeout(()=>{(this.buttonMask&n)!==0&&(this.buttonMask&=~n,this.send([l,c,p,this.buttonMask,i].join(",")))},10)}_dropThreshold(){for(var e=0,i=this._queue.dequeue();!this._queue.isEmpty();){var s=this._queue.dequeue();s>=80&&i==s&&e++,i=s}return e>=2}_mouseWheelWrapper(e){var i=Math.trunc(Math.abs(e.deltaY));this._queue.size()<4&&this._queue.enqueue(i),this._queue.size()==4&&(this._dropThreshold()?(this._allowThreshold=!1,this._smallestDeltaY=1e4):this._allowThreshold=!0),this._allowThreshold&&this._allowTrackpadScrolling?(this._allowTrackpadScrolling=!1,this._mouseWheel(e),setTimeout(()=>this._allowTrackpadScrolling=!0,this._wheelThreshold)):this._allowThreshold||this._mouseWheel(e),e.preventDefault()}_mouseWheel(e){if(e.deltaY!==0){const i=e.deltaY<0?"up":"down";let s=Math.abs(Math.trunc(e.deltaY));s<this._smallestDeltaY&&s!==0&&(this._smallestDeltaY=s);const n=Math.max(1,Math.floor(s/this._smallestDeltaY)),l=Math.min(n,this._scrollMagnitude);this._triggerMouseWheel(i,l)}if(e.deltaX!==0){const i=e.deltaX<0?"left":"right",s=Math.max(1,Math.round(Math.abs(e.deltaX)/100)),n=Math.min(s,this._scrollMagnitude);this._triggerHorizontalMouseWheel(i,n)}}_contextMenu(e){this.element.contains(e.target)&&e.preventDefault()}_pointerLock(){document.pointerLockElement===this.element?(this.send("p,1"),this.send("SET_NATIVE_CURSOR_RENDERING,1")):(this.send("p,0"),this.send("SET_NATIVE_CURSOR_RENDERING,0"),this.resetKeyboard())}_windowMath(){const e=this.element.getBoundingClientRect(),i=e.width,s=e.height,n=this.element.offsetWidth,l=this.element.offsetHeight;if(i<=0||s<=0||n<=0||l<=0){this.m=null;return}const c=i/n,p=s/l,h=Math.min(c,p),b=n*h,S=l*h,r=(i-b)/2,a=(s-S)/2,u=b>0?n/b:1,f=S>0?l/S:1;this.m={mouseMultiX:u,mouseMultiY:f,mouseOffsetX:r,mouseOffsetY:a,elementClientX:e.left,elementClientY:e.top,frameW:n,frameH:l}}_clientToServerX(e){if(!this.m)return 0;let n=(e-this.m.elementClientX-this.m.mouseOffsetX)*this.m.mouseMultiX;return Math.round(n)}_clientToServerY(e){if(!this.m)return 0;let n=(e-this.m.elementClientY-this.m.mouseOffsetY)*this.m.mouseMultiY;return Math.round(n)}_gamepadConnected(e){const i=this.controllerSlot!==null?this.controllerSlot-1:this.playerIndex;if(i==null)return;this.gamepadManager||(this.gamepadManager=new pi(e.gamepad,this._gamepadButton.bind(this),this._gamepadAxis.bind(this)));const s="js,c,"+i+","+btoa(e.gamepad.id)+","+e.gamepad.axes.length+","+e.gamepad.buttons.length;this.send(s),this.ongamepadconnected!==null&&this.ongamepadconnected(e.gamepad.id)}_gamepadDisconnect(e){this.ongamepaddisconneceted!==null&&this.ongamepaddisconneceted();const i=this.controllerSlot!==null?this.controllerSlot-1:this.playerIndex;i!=null&&this.send("js,d,"+i)}_gamepadButton(e,i,s){const n=this.controllerSlot!==null?this.controllerSlot-1:this.playerIndex;n===void 0||n<0||(this.send("js,b,"+n+","+i+","+s),this._isSidebarOpen&&window.postMessage({type:"gamepadButtonUpdate",gamepadIndex:n,buttonIndex:i,value:s},window.location.origin))}_gamepadAxis(e,i,s){const n=this.controllerSlot!==null?this.controllerSlot-1:this.playerIndex;n===void 0||n<0||(this.send("js,a,"+n+","+i+","+s),this._isSidebarOpen&&window.postMessage({type:"gamepadAxisUpdate",gamepadIndex:n,axisIndex:i,value:s},window.location.origin))}_onFullscreenChange(){document.fullscreenElement===this.element.parentElement?(document.pointerLockElement!==this.element&&this.element.requestPointerLock().catch(e=>console.warn("Pointer lock failed on fullscreen:",e)),this.requestKeyboardLock()):(document.pointerLockElement===this.element&&document.exitPointerLock(),this.send("kr"),this.resetKeyboard())}_targetHasClass(e,i){let s=e;for(;s&&s.classList;){if(s.classList.contains(i))return!0;s=s.parentElement}return!1}getWindowResolution(){const e=document.body?document.body.offsetWidth:window.innerWidth,i=document.body?document.body.offsetHeight:window.innerHeight,s=window.devicePixelRatio||1,n=e*s,l=i*s;return[Math.max(1,parseInt(n-n%2)),Math.max(1,parseInt(l-l%2))]}isInputAttached(){return this.inputAttached}attach(){if(this.listeners.push(I(this.element,"resize",this._windowMath,this)),this.listeners.push(I(document,"pointerlockchange",this._pointerLock,this)),this.listeners.push(I(document,"fullscreenchange",this._onFullscreenChange,this)),this.listeners.push(I(window,"resize",this._windowMath,this)),this.listeners.push(I(window,"gamepadconnected",this._gamepadConnected,this)),this.listeners.push(I(window,"gamepaddisconnected",this._gamepadDisconnect,this)),this.listeners.push(I(window,"message",this._handleVisibilityMessage,this)),!this.isSharedMode)this.attach_context();else{const e=i=>i.preventDefault();this.listeners.push(I(this.element,"touchstart",e,this)),this.listeners.push(I(this.element,"touchend",e,this)),this.listeners.push(I(this.element,"touchmove",e,this)),this.listeners.push(I(this.element,"touchcancel",e,this))}}attach_context(){if(this.inputAttached)return;this._windowMath(),this.element.style.setProperty("cursor","none","important"),(this._cursorImageBitmap||this._cursorBase64Data)&&(this.use_browser_cursors?this._updateBrowserCursor():(this.cursorDiv.style.display="block",this._drawAndScaleCursor())),this.listeners_context.push(I(window,"keydown",this._handleKeyDown,this,!0)),this.listeners_context.push(I(window,"keyup",this._handleKeyUp,this,!0)),this.listeners_context.push(I(window,"blur",this.resetKeyboard,this)),this.listeners_context.push(I(this.keyboardInputAssist,"input",this._handleMobileInput,this)),this.listeners_context.push(I(document,"mousedown",this._handleOutsideClick,this,!0)),this.listeners_context.push(I(document,"touchstart",this._handleOutsideClick,this,!0)),this.listeners_context.push(I(this.element,"wheel",this._mouseWheelWrapper,this)),this.listeners_context.push(I(this.element,"contextmenu",this._contextMenu,this));const e=this.element;this.listeners_context.push(I(e,"compositionstart",this._compositionStart,this)),this.listeners_context.push(I(e,"compositionupdate",this._compositionUpdate,this)),this.listeners_context.push(I(e,"compositionend",this._compositionEnd,this)),Q.isLinux()&&this.listeners_context.push(I(this.element,"textInput",this._handleTextInput,this)),this.listeners_context.push(I(this.element,"pointerdown",this._handlePointerDown,this)),this.listeners_context.push(I(this.element,"pointermove",this._handlePointerMove,this)),this.listeners_context.push(I(this.element,"pointerup",this._handlePointerUp,this)),this.listeners_context.push(I(this.element,"pointercancel",this._handlePointerUp,this)),"ontouchstart"in window&&(this.listeners_context.push(I(this.element,"touchstart",this._handleTouchEvent,this,!1)),this.listeners_context.push(I(this.element,"touchend",this._handleTouchEvent,this,!1)),this.listeners_context.push(I(this.element,"touchmove",this._handleTouchEvent,this,!1)),this.listeners_context.push(I(this.element,"touchcancel",this._handleTouchEvent,this,!1))),this.listeners_context.push(I(this.element,"mousedown",this._mouseButtonMovement,this)),this.listeners_context.push(I(window,"mousemove",this._mouseButtonMovement,this)),this.listeners_context.push(I(window,"mouseup",this._mouseButtonMovement,this)),document.fullscreenElement===this.element.parentElement?(document.pointerLockElement!==this.element&&this.element.requestPointerLock().catch(()=>{}),this.requestKeyboardLock()):document.pointerLockElement===this.element&&this._pointerLock(),this._windowMath(),this.inputAttached=!0}detach(){ei(this.listeners),this.listeners=[],this.gamepadManager&&(this.gamepadManager.destroy(),this.gamepadManager=null),this.detach_context()}detach_context(){ei(this.listeners_context),this.listeners_context=[],this.element.style.cursor="auto",this.cursorDiv.style.display="none",this.send("kr"),this.resetKeyboard(),this._activeTouches.clear(),this._activeTouchIdentifier=null,this._isTwoFingerGesture=!1,(this.buttonMask&1)===1&&(this.buttonMask&=-2,this._sendMouseState()),this.inputAttached=!1,this._exitPointerLock()}_exitPointerLock(){document.pointerLockElement===this.element&&document.exitPointerLock()}enterFullscreen(){this.element.parentElement&&document.fullscreenElement===null?this.element.parentElement.requestFullscreen().catch(e=>console.error("Fullscreen request failed:",e)):document.fullscreenElement!==null&&document.pointerLockElement!==this.element&&this.element.requestPointerLock().catch(()=>{})}requestKeyboardLock(){if(document.fullscreenElement&&"keyboard"in navigator&&"lock"in navigator.keyboard){const e=["AltLeft","AltRight","Tab","Escape","MetaLeft","MetaRight","ContextMenu"];navigator.keyboard.lock(e).then(()=>{}).catch(i=>{})}}}function I(t,e,i,s,n=!1){if(!t||typeof t.addEventListener!="function")return console.error("addListener: Invalid target object",t),null;const l=s?i.bind(s):i,c={capture:n,passive:!1};return t.addEventListener(e,l,c),[t,e,l,c]}function ei(t){for(const e of t)e&&e[0]&&typeof e[0].removeEventListener=="function"&&e[0].removeEventListener(e[1],e[2],e[3]);t.length=0}let v,ai=!1,$t=!1,T=null,g=null,M=null,d,xt=null,Z=null,L=null,qe=!1,A,je,_e,wt=1,pe;window.currentAudioBufferSize=0;let $e=[],xe=[],et=()=>{console.error("initializeDecoder function not yet assigned!")},N=!0,H=!0,Y=!1,re,ge=-1,Tt=!1,yt=!1,E="primary",zt="right";const ze=["framerate","h264_crf","h264_fullcolor","h264_streaming_mode","jpeg_quality","paint_over_jpeg_quality","use_cpu","h264_paintover_crf","h264_paintover_burst_frames","use_paint_over_quality","is_manual_resolution_mode","manual_width","manual_height","encoder","scaleLocallyManual","use_browser_cursors"];let Pe=null,ee=null,tt=null,me=null,Ae=null,De=null,te=null,se=null,ce=null;const ti=500,ii=50,_i=1024*1024-1,mi=200;let At={};window.is_manual_resolution_mode=!1;let m=null,y=null,Ie=null,Ot=null,oe={},Xe=null,k="x264enc-stiped",q=!1,Oe=!1,kt=96,Le=!0,Me=!1;function It(){const t=B("use_browser_cursors",!1),e=E==="display2"||E==="primary"&&$t,i=e?!0:t;window.webrtcInput&&typeof window.webrtcInput.setUseBrowserCursors=="function"&&(console.log(`Applying effective cursor setting. Multi-monitor: ${e}, User Pref: ${t}, Final: ${i}`),window.webrtcInput.setUseBrowserCursors(i))}function oi(){const t=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${t}px`)}let We=!1,U={data:[],mimeType:"",totalSize:0,receivedSize:0,inProgress:!1};const Dt=750*1024;let le=null,ie=0;const wi=new URLSearchParams(window.location.search),ri=wi.get("token");if(ri)qe=!0,console.log("Client is running in Token Authentication mode.");else{const t=window.location.hash;if(t==="#shared")le="shared",ie=void 0;else if(t==="#player2")le="player2",ie=1;else if(t==="#player3")le="player3",ie=2;else if(t==="#player4")le="player4",ie=3;else if(t.startsWith("#display2")){E="display2";const e=t.split("-");if(e.length>1){const i=e[1];["left","right","up","down"].includes(i)&&(zt=i)}}}let P="idle",W=null;const yi=7e3;let Xt=null,de=0;const ni=3;let x=le!==null,Je=!1;x&&console.log(`Client is running in ${le} mode.`);E==="display2"&&console.log("Client is running in Secondary Display mode.");window.onload=()=>{};const bi=window.location.href.split("#")[0],ye=bi.replace(/[^a-zA-Z0-9.-_]/g,"_");document.title="Selkies";fetch("manifest.json").then(t=>t.json()).then(t=>{t.name&&(document.title=t.name)}).catch(()=>{});let st=60,at=25,rt=!1,lt=!1,ct=60,dt=90,vt=!1,ut=18,ft=5,Ft=!0,Nt=32e4,Re="connecting",Ke="";const Si={gpuLoad:0,gpuMemoryTotal:0,gpuMemoryUsed:0},Ki={serverCPUUsage:0,serverMemoryTotal:0,serverMemoryUsed:0},ki={bandwidthMbps:0,latencyMs:0};let it=!1,Ne=!1,Ue=!1,ne;window.fps=0;let Fe=0,gt=new Set,_t=performance.now(),Qe=performance.now(),F,J,j;const G=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`);const n=window.localStorage.getItem(s);return n==null?e:parseInt(n)},$=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`),e==null?window.localStorage.removeItem(s):window.localStorage.setItem(s,e.toString())},B=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`);const n=window.localStorage.getItem(s);return n===null?e:n.toString().toLowerCase()==="true"},V=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`),e==null?window.localStorage.removeItem(s):window.localStorage.setItem(s,e.toString())},Ht=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`);const n=window.localStorage.getItem(s);return n??e},ht=(t,e)=>{const i=`${ye}_${t}`;let s=i;E==="display2"&&ze.includes(t)&&(s=`${i}_${E}`),e==null?window.localStorage.removeItem(s):window.localStorage.setItem(s,e.toString())};function Xi(t){console.log("Sanitizing and storing settings based on server payload.");const e={};for(const i in t){if(!t.hasOwnProperty(i))continue;const s=t[i];let n;if(s.min!==void 0&&s.max!==void 0){const l=G(i,s.default);l<s.min||l>s.max?(n=s.default,console.log(`Sanitizing '${i}': value ${l} is out of range [${s.min}-${s.max}]. Resetting to default ${n}.`),e[i]=n):n=l,window[i]=n,$(i,n)}else if(s.allowed!==void 0){const l=!isNaN(parseFloat(s.allowed[0]));let c;if(l?c=G(i,parseInt(s.value,10)).toString():c=Ht(i,s.value),s.allowed.includes(c)?n=c:(n=s.value,console.log(`Sanitizing '${i}': value "${c}" is not in allowed list [${s.allowed.join(", ")}]. Resetting to default "${n}".`),e[i]=n),l){const p=parseInt(n,10);window[i]=p,$(i,p)}else window[i]=n,ht(i,n)}else if(typeof s.value=="boolean"){const l=s.value;if(!!s.locked){const p=B(i,!l);p!==l&&(console.log(`Sanitizing '${i}': setting is locked by server. Client value ${p} is being overwritten with ${l}.`),e[i]=l),window[i]=l,V(i,l)}else{const p=`${ye}_${i}`,h=window.localStorage.getItem(p)===null,b=B(i,l);h&&(console.log(`Initializing unlocked setting '${i}' for the first time with server default: ${l}. Flagging as a change.`),e[i]=l),window[i]=b,V(i,b)}}}return e}st=G("framerate",st);at=G("h264_crf",at);rt=B("h264_fullcolor",rt);lt=B("h264_streaming_mode",lt);ct=G("jpeg_quality",ct);dt=G("paint_over_jpeg_quality",dt);vt=B("use_cpu",vt);ut=G("h264_paintover_crf",ut);ft=G("h264_paintover_burst_frames",ft);Ft=B("use_paint_over_quality",Ft);Nt=G("audio_bitrate",Nt);it=B("debug",it);k=Ht("encoder","x264enc");ne=B("scaleLocallyManual",!0);is_manual_resolution_mode=B("is_manual_resolution_mode",!1);re=B("isGamepadEnabled",!0);q=B("useCssScaling",!1);Oe=B("trackpadMode",!1);kt=G("scaling_dpi",96);Le=B("antiAliasingEnabled",!0);Me=B("use_browser_cursors",!1);E==="display2"&&(Me=!0);We=B("enable_binary_clipboard",We);$("framerate",st);$("h264_crf",at);$("jpeg_quality",ct);$("paint_over_jpeg_quality",dt);$("h264_paintover_crf",ut);$("h264_paintover_burst_frames",ft);$("audio_bitrate",Nt);ht("encoder",k);$("scaling_dpi",kt);x?(m=1280,y=720,console.log(`Shared mode: Initialized manual_width/Height to ${m}x${y}`)):(m=G("manual_width",null),$("manual_width",m),y=G("manual_height",null),$("manual_height",y));const vi=()=>{"webrtcInput"in window&&window.webrtcInput&&typeof window.webrtcInput.enterFullscreen=="function"&&window.webrtcInput.enterFullscreen()},Fi=()=>{J&&J.classList.add("hidden"),F&&F.classList.add("hidden"),Vt(),console.log("playStream called in WebSocket mode - UI elements hidden.")},Ce=()=>{F&&(F.textContent=Ke||Re)};window.applyTimestamp=t=>{const e=new Date;return`[${`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`}] ${t}`};const C=t=>Math.floor(t/2)*2,Ct=()=>{if(!g)return;if(!Le){g.style.imageRendering!=="pixelated"&&(console.log("Anti-aliasing disabled by setting. Forcing 'pixelated' rendering."),g.style.imageRendering="pixelated",g.style.setProperty("image-rendering","crisp-edges",""));return}const t=window.devicePixelRatio||1;x||window.is_manual_resolution_mode||q&&t>1?g.style.imageRendering!=="auto"&&(console.log("Smoothing enabled for manual resolution, high-DPR scaling, or shared mode."),g.style.imageRendering="auto"):g.style.imageRendering!=="pixelated"&&(console.log("Setting canvas rendering to 'pixelated' for 1:1 display."),g.style.imageRendering="pixelated",g.style.setProperty("image-rendering","crisp-edges",""))},Ci=()=>{const t=document.createElement("style");t.textContent=`
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #000;
  color: #fff;
}
#app {
  display: flex;
  flex-direction: column;
  height: calc(var(--vh, 1vh) * 100);
  width: 100%;
}
.video-container {
  flex-grow: 1;
  flex-shrink: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  width: 100%;
  position: relative;
  overflow: hidden;
}
.video-container video,
.video-container canvas,
.video-container #overlayInput {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.video-container video {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: none;
}
.video-container #videoCanvas {
    z-index: 2;
    pointer-events: none;
    display: block;
}
.video-container #overlayInput {
    opacity: 0;
    z-index: 3;
    caret-color: transparent;
    background-color: transparent;
    color: transparent;
    pointer-events: auto;
    -webkit-user-select: none;
    border: none;
    outline: none;
    padding: 0;
    margin: 0;
}
.video-container #playButton {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
}
.hidden {
  display: none !important;
}
.video-container .status-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 5px;
  background-color: rgba(0, 0, 0, 0.7);
  color: #fff;
  text-align: center;
  z-index: 5;
}
#playButton {
  padding: 15px 30px;
  font-size: 1.5em;
  cursor: pointer;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 3px;
  backdrop-filter: blur(5px);
}
.video-container.shared-user-mode #overlayInput {
  cursor: default !important;
}
  `,document.head.appendChild(t)};function Pi(t){if(!x)if(d&&d.readyState===WebSocket.OPEN){const e=Ii(),s=`SETTINGS,${JSON.stringify(e)}`;d.send(s),console.log(`[websockets] Sent full settings update. Reason: ${t}`)}else console.warn(`[websockets] Cannot send full settings update. Reason: ${t}. WebSocket not open.`)}function Ii(){const t={},e=q?1:window.devicePixelRatio||1;if(t.framerate=G("framerate",60),t.h264_crf=G("h264_crf",25),t.encoder=Ht("encoder","x264enc"),t.is_manual_resolution_mode=B("is_manual_resolution_mode",!1),t.audio_bitrate=G("audio_bitrate",32e4),t.h264_fullcolor=B("h264_fullcolor",!1),t.h264_streaming_mode=B("h264_streaming_mode",!1),t.jpeg_quality=G("jpeg_quality",60),t.paint_over_jpeg_quality=G("paint_over_jpeg_quality",90),t.use_cpu=B("use_cpu",!1),t.h264_paintover_crf=G("h264_paintover_crf",18),t.h264_paintover_burst_frames=G("h264_paintover_burst_frames",5),t.use_paint_over_quality=B("use_paint_over_quality",!0),t.scaling_dpi=G("scaling_dpi",96),t.enable_binary_clipboard=B("enable_binary_clipboard",!1),window.is_manual_resolution_mode&&m!=null&&y!=null)t.is_manual_resolution_mode=!0,t.manual_width=C(m*e),t.manual_height=C(y*e);else{const i=document.querySelector(".video-container"),s=i?i.getBoundingClientRect():{width:window.innerWidth,height:window.innerHeight};t.is_manual_resolution_mode=!1,t.initialClientWidth=C(s.width*e),t.initialClientHeight=C(s.height*e)}return t.useCssScaling=q,t.displayId=E,E==="display2"&&(t.displayPosition=zt),t}function bt(t,e){if(x){console.log("Shared mode: Resolution sending to server is blocked.");return}let i,s,n=1;window.is_manual_resolution_mode?(i=C(t),s=C(e)):(n=q?1:window.devicePixelRatio||1,i=C(t*n),s=C(e*n));const l=`${i}x${s}`;console.log(`Sending resolution to server: ${l}, DisplayID: ${E}, Manual Mode: ${window.is_manual_resolution_mode}, Pixel Ratio Used: ${n}, useCssScaling: ${q}`),d&&d.readyState===WebSocket.OPEN?d.send(`r,${l},${E}`):console.warn("Cannot send resolution via WebSocket: Connection not open.")}function z(t,e,i){if(!g||!g.parentElement){console.error("Cannot apply manual canvas style: Canvas or parent container not found.");return}if(t<=0||e<=0){console.warn(`Cannot apply manual canvas style: Invalid target dimensions ${t}x${e}`);return}const s=x||window.is_manual_resolution_mode||q?1:window.devicePixelRatio||1,n=C(t*s),l=C(e*s);(g.width!==n||g.height!==l)&&(g.width=n,g.height=l,console.log(`Canvas internal buffer set to: ${n}x${l}`));const c=g.parentElement,p=c.clientWidth,h=c.clientHeight;if(i){const b=t/e,S=p/h;let r,a;b>S?(r=p,a=p/b):(a=h,r=h*b);const u=(h-a)/2,f=(p-r)/2;g.style.position="absolute",g.style.width=`${r}px`,g.style.height=`${a}px`,g.style.top=`${u}px`,g.style.left=`${f}px`,g.style.objectFit="contain",console.log(`Applied manual style (Scaled): CSS ${r.toFixed(2)}x${a.toFixed(2)}, Buffer ${n}x${l}, Pos ${f.toFixed(2)},${u.toFixed(2)}`)}else g.style.position="absolute",g.style.width=`${t}px`,g.style.height=`${e}px`,g.style.top="0px",g.style.left="0px",g.style.objectFit="fill",console.log(`Applied manual style (Exact): CSS ${t}x${e}, Buffer ${n}x${l}, Pos 0,0`);g.style.display="block",Ct()}function pt(t,e){if(!g)return;if(t<=0||e<=0){console.warn(`Cannot reset canvas style: Invalid stream dimensions ${t}x${e}`);return}const i=q?1:window.devicePixelRatio||1,s=C(t*i),n=C(e*i);(g.width!==s||g.height!==n)&&(g.width=s,g.height=n,console.log(`Canvas internal buffer reset to: ${s}x${n}`)),g.style.width=`${t}px`,g.style.height=`${e}px`;const l=g.parentElement;if(l){const c=l.clientWidth,p=l.clientHeight,h=Math.floor((c-t)/2),b=Math.floor((p-e)/2);g.style.position="absolute",g.style.top=`${b}px`,g.style.left=`${h}px`,console.log(`Reset canvas CSS to ${t}px x ${e}px, Pos ${h},${b}, object-fit: fill. Buffer: ${s}x${n}`)}else g.style.position="absolute",g.style.top="0px",g.style.left="0px",console.log(`Reset canvas CSS to ${t}px x ${e}px, Pos 0,0 (no parent metrics), object-fit: fill. Buffer: ${s}x${n}`);g.style.objectFit="fill",g.style.display="block",Ct()}function li(){Pt&&(console.log("Switching to Auto Mode: Removing direct manual local scaling listener."),window.removeEventListener("resize",Pt)),Ie?(console.log("Switching to Auto Mode: Adding original (auto) debounced resize listener."),window.removeEventListener("resize",Ie),window.addEventListener("resize",Ie),typeof Ot=="function"?(console.log("Triggering immediate auto-resize calculation for auto mode."),Ot()):console.warn("handleResizeUI function not directly callable from enableAutoResize. Auto-resize will occur on next event.")):console.warn("Cannot enable auto-resize: originalWindowResizeHandler not found.")}const Pt=()=>{window.is_manual_resolution_mode&&!x&&m!=null&&y!=null&&m>0&&y>0&&z(m,y,ne)};function Mt(){Ie&&(console.log("Switching to Manual Mode Local Scaling: Removing original (auto) resize listener."),window.removeEventListener("resize",Ie)),console.log("Switching to Manual Mode Local Scaling: Adding direct manual scaling listener."),window.removeEventListener("resize",Pt),window.addEventListener("resize",Pt),window.is_manual_resolution_mode&&!x&&m!=null&&y!=null&&m>0&&y>0&&(console.log("Applying current manual canvas style after enabling direct manual resize handler."),z(m,y,ne))}function Ut(){if(!x)return;const t=document.querySelector(".video-container");t&&(t.classList.add("shared-user-mode"),console.log("Shared mode: Added 'shared-user-mode' class to video container."));const e=document.getElementById("globalFileInput");e&&(e.disabled=!0,console.log("Shared mode: Disabled globalFileInput."))}const Mi=()=>{Ci(),oi(),window.addEventListener("resize",oi),window.addEventListener("requestFileUpload",Ai);const t=document.getElementById("app");if(!t){console.error("FATAL: Could not find #app element.");return}const e=document.createElement("div");e.className="video-container",F=document.createElement("div"),F.id="status-display",F.className="status-bar",F.textContent="Connecting...",e.appendChild(F),j=document.createElement("input"),j.type="text",j.readOnly=!1,j.autocomplete="off",j.id="overlayInput",e.appendChild(j),g=document.getElementById("videoCanvas"),g||(g=document.createElement("canvas"),g.id="videoCanvas"),e.appendChild(g),x?((!m||m<=0||!y||y<=0)&&(m=1280,y=720),z(m,y,!0),window.addEventListener("resize",()=>{x&&m&&y&&m>0&&y>0&&z(m,y,!0)}),console.log(`Initialized UI in Shared Mode: Canvas buffer target ${m}x${y} (logical), will scale to fit viewport.`)):is_manual_resolution_mode&&m!=null&&y!=null&&m>0&&y>0?(z(m,y,ne),Mt(),console.log(`Initialized UI in Manual Resolution Mode: ${m}x${y} (logical), ScaleLocally: ${ne}`)):(pt(1024,768),console.log("Initialized UI in Auto Resolution Mode (defaulting to 1024x768 logical for now)")),M=g.getContext("2d"),M||console.error("Failed to get 2D rendering context"),J=document.createElement("button"),J.id="playButton",J.textContent="Play Stream",e.appendChild(J),J.classList.add("hidden"),F.classList.remove("hidden");const i=document.createElement("div");i.id="dev-sidebar";const s=document.createElement("input");if(s.type="file",s.id="globalFileInput",s.multiple=!0,s.style.display="none",document.body.appendChild(s),s.addEventListener("change",Di),!document.getElementById("keyboard-input-assist")){const n=document.createElement("input");n.type="text",n.id="keyboard-input-assist",n.style.position="absolute",n.style.left="-9999px",n.style.top="-9999px",n.style.width="1px",n.style.height="1px",n.style.opacity="0",n.style.border="0",n.style.padding="0",n.style.caretColor="transparent",n.setAttribute("aria-hidden","true"),n.setAttribute("autocomplete","off"),n.setAttribute("autocorrect","off"),n.setAttribute("autocapitalize","off"),n.setAttribute("spellcheck","false"),document.body.appendChild(n),console.log("Dynamically added #keyboard-input-assist element.")}t.appendChild(e),Ce(),J.addEventListener("click",Fi),x&&Ut()};function we(){console.log("Clearing all VNC stripe decoders.");for(const t in oe)if(oe.hasOwnProperty(t)){const e=oe[t];if(e.decoder&&e.decoder.state!=="closed")try{e.decoder.close(),console.log(`Closed VNC stripe decoder for Y=${t}`)}catch(i){console.error(`Error closing VNC stripe decoder for Y=${t}:`,i)}}oe={},console.log("All VNC stripe decoders and metadata cleared.")}function Ei(t){const e=oe[t];if(!(!e||e.decoder.state!=="configured"||!e.pendingChunks))for(console.log(`Processing ${e.pendingChunks.length} pending chunks for stripe Y=${t}`);e.pendingChunks.length>0;){const i=e.pendingChunks.shift(),s=new EncodedVideoChunk({type:i.type,timestamp:i.timestamp,data:i.data});try{e.decoder.decode(s)}catch(n){console.error(`Error decoding pending chunk for stripe Y=${t}:`,n,s)}}}let ke=[];function Ti(t,e,i){ke.push({yPos:t,frame:i,vncFrameID:e})}function Ai(){if(x){console.log("Shared mode: File upload via requestFileUpload blocked.");return}const t=document.getElementById("globalFileInput");if(!t){console.error("Global file input not found!");return}if(!d||d.readyState!==WebSocket.OPEN){console.warn("WebSocket is not open. File upload cannot be initiated.");return}console.log("Triggering click on hidden file input."),t.click()}async function Di(t){if(x){console.log("Shared mode: File upload via fileInputChange blocked."),t.target.value=null;return}const e=t.target.files;if(!e||e.length===0){t.target.value=null;return}if(console.log(`File input changed, processing ${e.length} files sequentially.`),!d||d.readyState!==WebSocket.OPEN){console.error("WebSocket is not open. Cannot upload selected files."),window.postMessage({type:"fileUpload",payload:{status:"error",fileName:"N/A",message:"WebSocket not open for upload."}},window.location.origin),t.target.value=null;return}try{for(let i=0;i<e.length;i++){const s=e[i],n=s.name;console.log(`Uploading file ${i+1}/${e.length}: ${n}`),await Gt(s,n)}console.log("Finished processing all files from input.")}catch(i){const s=`An error occurred during the file input upload process: ${i.message||i}`;if(console.error(s),window.postMessage({type:"fileUpload",payload:{status:"error",fileName:"N/A",message:s}},window.location.origin),d&&d.readyState===WebSocket.OPEN)try{d.send("FILE_UPLOAD_ERROR:GENERAL:File input processing failed")}catch{}}finally{t.target.value=null}}const Vt=async()=>{if(Xe===null)if("wakeLock"in navigator)try{Xe=await navigator.wakeLock.request("screen"),Xe.addEventListener("release",()=>{console.log("Screen Wake Lock was released automatically."),Xe=null}),console.log("Screen Wake Lock is active.")}catch(t){console.error(`Could not acquire Wake Lock: ${t.name}, ${t.message}`)}else console.warn("Wake Lock API is not supported by this browser.")},Wt=async()=>{Xe!==null&&(await Xe.release(),Xe=null)};function Li(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout(()=>{t.apply(this,s)},e)}}const Lt=()=>{Ne||(Ne=!0,F&&F.classList.add("hidden"),J&&J.classList.add("hidden"),console.log("Stream started (UI elements hidden)."))},Ve=()=>{if(Ue){console.log("Input already initialized. Skipping.");return}L!==null&&L>0&&(ie=L-1,console.log(`Input Initialization: Applying server-provided slot ${L}. Gamepad will target index ${ie}.`)),Ue=!0,console.log("Initializing Input system...");let t;const i=c=>{d&&d.readyState===WebSocket.OPEN?d.send(c):console.warn("initializeInput: WebSocket not open, cannot send input message:",c)};if(!j){console.error("initializeInput: overlayInput element not found. Cannot initialize input handling."),Ue=!1;return}const s=L;if(t=new Bt(j,i,x,ie,q,s),t.getWindowResolution=()=>{const c=document.querySelector(".video-container");if(!c)return console.warn("initializeInput: .video-container not found, using window inner dimensions for resolution calculation."),[window.innerWidth,window.innerHeight];const p=c.getBoundingClientRect();return[p.width,p.height]},t.ongamepadconnected=c=>{console.log(`Client: Gamepad "${c}" connected. isSharedMode: ${x}, isGamepadEnabled (global toggle): ${re}`),window.webrtcInput&&window.webrtcInput.gamepadManager?x?(window.webrtcInput.gamepadManager.enable(),console.log("Shared mode: Gamepad connected, ensuring its GamepadManager is active for polling.")):re?(window.webrtcInput.gamepadManager.enable(),console.log("Primary mode: Gamepad connected, master gamepad toggle is ON. Ensuring its GamepadManager is active.")):(window.webrtcInput.gamepadManager.disable(),console.log("Primary mode: Gamepad connected, but master gamepad toggle is OFF. Disabling its GamepadManager.")):console.warn("Client: window.webrtcInput.gamepadManager not found in ongamepadconnected. Cannot control its polling state.")},t.ongamepaddisconnected=()=>{console.log("Gamepad disconnected.")},t.attach(),Z==="viewer"){const c=L!==null?`(gamepad-only slot ${L})`:"(no slot)";console.log(`Role is 'viewer' ${c}. Detaching context to disable mouse/keyboard/touch.`),t.detach_context()}if(window.webrtcInput=t,It(),j){const c=p=>{Vt()};j.removeEventListener("pointerdown",c),j.addEventListener("pointerdown",c),j.addEventListener("contextmenu",p=>{p.preventDefault()})}const n=()=>{if(!yt)return;if(x){console.log("Shared mode: handleResizeUI (auto-resize logic) skipped."),m&&y&&m>0&&y>0&&z(m,y,!0);return}if(window.is_manual_resolution_mode){console.log("handleResizeUI: Auto-resize skipped, manual resolution mode is active.");return}console.log("handleResizeUI: Auto-resize triggered (e.g., by window resize event).");const c=t.getWindowResolution(),p=C(c[0]),h=C(c[1]);if(p<=0||h<=0){console.warn(`handleResizeUI: Calculated invalid dimensions (${p}x${h}). Skipping resize send.`);return}bt(p,h),pt(p,h)};if(Ot=n,Ie=Li(n,500),x)console.log("Shared mode: Auto-resize event listener (originalWindowResizeHandler) NOT attached.");else if(window.is_manual_resolution_mode)console.log("initializeInput: Manual resolution mode active. Initial resolution already sent by onopen."),m!=null&&y!=null&&m>0&&y>0?Mt():console.warn("initializeInput: Manual mode is set, but manual_width/Height are invalid. Canvas might not display correctly.");else{console.log("initializeInput: Auto-resolution mode. Attaching 'resize' event listener for subsequent changes."),window.addEventListener("resize",Ie);const c=document.querySelector(".video-container");let p,h;if(c){const b=c.getBoundingClientRect();p=C(b.width),h=C(b.height)}else p=C(window.innerWidth),h=C(window.innerHeight);(p<=0||h<=0)&&(console.warn(`initializeInput: Current auto-calculated dimensions are invalid (${p}x${h}). Defaulting canvas style to 1024x768 (logical) for initial setup. The resolution sent by onopen should prevail on the server.`),p=1024,h=768),pt(p,h),console.log(`initializeInput: Canvas style reset to reflect current auto-dimensions: ${p}x${h} (logical). Initial resolution was already sent by onopen.`)}j&&!x?(j.addEventListener("dragover",Ni),j.addEventListener("drop",Ui)):j&&x?console.log("Shared mode: Drag/drop file upload listeners NOT attached to overlayInput."):console.warn("initializeInput: overlayInput not found, cannot attach drag/drop listeners.");const l=document.getElementById("keyboard-input-assist");l&&t&&!x?(l.addEventListener("input",c=>{const p=l.value;p&&(t._typeString(p),l.value="")}),l.addEventListener("keydown",c=>{c.key==="Enter"||c.keyCode===13?(t._guac_press(65293),setTimeout(()=>t._guac_release(65293),5),c.preventDefault(),l.value=""):(c.key==="Backspace"||c.keyCode===8)&&(t._guac_press(65288),setTimeout(()=>t._guac_release(65288),5),c.preventDefault())}),console.log("initializeInput: Added 'input' and 'keydown' listeners to #keyboard-input-assist.")):x?console.log("Shared mode: Keyboard input assist listeners NOT attached."):console.error("initializeInput: Could not add listeners to keyboard assist: Element or Input handler instance not found."),console.log("Input system initialized.")};async function St(){if(!De){console.log("No preferred output device set, using default.");return}if(!(typeof AudioContext<"u"&&"setSinkId"in AudioContext.prototype||audioElement&&typeof audioElement.setSinkId=="function")){console.warn("Browser does not support setSinkId, cannot apply output device preference."),audioOutputSelectElement&&audioOutputSelectElement.classList.add("hidden");const e=document.getElementById("audioOutputLabel");e&&e.classList.add("hidden");return}if(A)if(A.state==="running")try{await A.setSinkId(De),console.log(`Playback AudioContext output set to device: ${De}`)}catch(e){console.error(`Error setting sinkId on Playback AudioContext (ID: ${De}): ${e.name}`,e)}else console.warn(`Playback AudioContext not running (state: ${A.state}), cannot set sinkId yet.`);else console.log("Playback AudioContext doesn't exist yet, sinkId will be applied on initialization.")}window.addEventListener("message",ci,!1);function Ee(){const t={type:"sidebarButtonStatusUpdate",video:N,audio:H,microphone:Y,gamepad:re};console.log("Posting sidebarButtonStatusUpdate:",t),window.postMessage(t,window.location.origin)}function ci(t){if(t.origin!==window.location.origin){console.warn(`Received message from unexpected origin: ${t.origin}. Expected ${window.location.origin}. Ignoring.`);return}const e=t.data;if(typeof e!="object"||e===null){console.warn("Received non-object message via window.postMessage:",e);return}if(!e.type){console.warn("Received message without a type property:",e);return}switch(e.type){case"setVolume":typeof e.value=="number"&&_e&&(wt=Math.max(0,Math.min(1,e.value)),_e.gain.setValueAtTime(wt,A.currentTime));break;case"setMute":typeof e.value=="boolean"&&_e&&(e.value===!0?_e.gain.setValueAtTime(0,A.currentTime):_e.gain.setValueAtTime(wt,A.currentTime));break;case"sidebarVisibilityChanged":ai=!!e.isOpen;break;case"setScaleLocally":if(x){console.log("Shared mode: setScaleLocally message ignored (forced true behavior).");break}typeof e.value=="boolean"?(ne=e.value,V("scaleLocallyManual",ne),console.log(`Set scaleLocallyManual to ${ne} and persisted.`),window.is_manual_resolution_mode&&m!==null&&y!==null&&(console.log("Applying new scaling style in manual mode."),z(m,y,ne))):console.warn("Invalid value received for setScaleLocally:",e.value);break;case"setSynth":window.webrtcInput&&typeof window.webrtcInput.setSynth=="function"&&window.webrtcInput.setSynth(e.value);break;case"showVirtualKeyboard":if(x){console.log("Shared mode: showVirtualKeyboard message ignored.");break}console.log("Received 'showVirtualKeyboard' message.");const i=document.getElementById("keyboard-input-assist"),s=document.getElementById("overlayInput");i?(i.value="",i.focus(),console.log("Focused #keyboard-input-assist element."),s.addEventListener("touchstart",()=>{document.activeElement===i&&i.blur()},{once:!0,passive:!0})):console.error("Could not find #keyboard-input-assist element to focus.");break;case"setUseCssScaling":if(typeof e.value=="boolean"){const K=q!==e.value;if(q=e.value,V("useCssScaling",q),console.log(`Set useCssScaling to ${q} and persisted.`),window.webrtcInput&&typeof window.webrtcInput.updateCssScaling=="function"&&window.webrtcInput.updateCssScaling(q),K){if(Ct(),window.is_manual_resolution_mode&&m!=null&&y!=null)bt(m,y),z(m,y,ne);else if(x)m&&y&&z(m,y,!0);else{const X=window.webrtcInput?window.webrtcInput.getWindowResolution():[window.innerWidth,window.innerHeight],D=C(X[0]),R=C(X[1]);bt(D,R),pt(D,R)}k!=="jpeg"&&k!=="x264enc"&&k!=="x264enc-striped"&&et()}}else console.warn("Invalid value received for setUseCssScaling:",e.value);break;case"setAntiAliasing":if(typeof e.value=="boolean"){const K=Le!==e.value;Le=e.value,V("antiAliasingEnabled",Le),console.log(`Set antiAliasingEnabled to ${Le} and persisted.`),K&&Ct()}else console.warn("Invalid value received for setAntiAliasing:",e.value);break;case"setUseBrowserCursors":typeof e.value=="boolean"?(Me=e.value,V("use_browser_cursors",Me),console.log(`Set use_browser_cursors to ${Me} and persisted.`),It()):console.warn("Invalid value received for setUseBrowserCursors:",e.value);break;case"setManualResolution":if(x){console.log("Shared mode: setManualResolution message ignored.");break}const n=parseInt(e.width,10),l=parseInt(e.height,10);if(isNaN(n)||n<=0||isNaN(l)||l<=0){console.error("Received invalid width/height for setManualResolution:",e);break}console.log(`Setting manual resolution: ${n}x${l} (logical)`),window.is_manual_resolution_mode=!0,m=C(n),y=C(l),console.log(`Rounded logical resolution to even numbers: ${m}x${y}`),$("manual_width",m),$("manual_height",y),V("is_manual_resolution_mode",!0),Mt(),bt(m,y),z(m,y,ne),(k==="x264enc"||k==="x264enc-striped")&&(console.log("Clearing VNC stripe decoders due to manual resolution change."),we(),M&&M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height));break;case"resetResolutionToWindow":if(x){console.log("Shared mode: resetResolutionToWindow message ignored.");break}console.log("Resetting resolution to window size."),window.is_manual_resolution_mode=!1,m=null,y=null,$("manual_width",null),$("manual_height",null),V("is_manual_resolution_mode",!1);const c=window.webrtcInput?window.webrtcInput.getWindowResolution():[window.innerWidth,window.innerHeight],p=C(c[0]),h=C(c[1]);pt(p,h),(k==="x264enc"||k==="x264enc-striped")&&(console.log("Clearing VNC stripe decoders due to resolution reset to window."),we(),M&&M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)),li();break;case"settings":console.log("Received settings message:",e.settings),di(e.settings);break;case"getStats":console.log("Received getStats message."),Ri();break;case"clipboardUpdateFromUI":if(console.log("Received clipboardUpdateFromUI message."),x){console.log("Shared mode: Clipboard write to server blocked.");break}const b=e.text;Kt(b);break;case"pipelineStatusUpdate":console.log("Received pipelineStatusUpdate message:",e);let S=!1;e.video!==void 0&&N!==e.video&&(N=e.video,S=!0),e.audio!==void 0&&H!==e.audio&&(H=e.audio,S=!0),e.microphone!==void 0&&Y!==e.microphone&&(Y=e.microphone,S=!0),e.gamepad!==void 0&&re!==e.gamepad&&(re=e.gamepad,S=!0),S&&Ee();break;case"pipelineControl":console.log(`Received pipeline control message: pipeline=${e.pipeline}, enabled=${e.enabled}`);const r=e.pipeline,a=e.enabled;let u="";if(r==="video"){if(x){console.log("Shared mode: Video pipelineControl blocked.");break}if(N!==a){if(N=a,u=a?"START_VIDEO":"STOP_VIDEO",a){if(console.log("Client: START_VIDEO requested via pipelineControl. Clearing canvas visually. Server will send PIPELINE_RESETTING for full state reset."),M&&g)try{M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)}catch(K){console.error("Error clearing canvas on START_VIDEO request:",K)}}else if(console.log("Client: STOP_VIDEO requested via pipelineControl. Clearing canvas visually. Server will send PIPELINE_RESETTING for full state reset."),M&&g)try{M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)}catch(K){console.error("Error clearing canvas on STOP_VIDEO request:",K)}}}else if(r==="audio"){if(E!=="primary"){console.log("Secondary display: Audio control blocked.");break}H!==a&&(H=a,u=a?"START_AUDIO":"STOP_AUDIO",T&&T.postMessage({type:"updatePipelineStatus",data:{isActive:H}}))}else if(r==="microphone"){if(x){console.log("Shared mode: Microphone control blocked.");break}a?si():Be()}else console.warn(`Received pipelineControl message for unknown pipeline: ${r}`);if(u&&d&&d.readyState===WebSocket.OPEN)try{d.send(u),console.log(`Sent command to server via WebSocket: ${u}`)}catch(K){console.error(`Error sending ${u} to WebSocket:`,K)}break;case"audioDeviceSelected":if(console.log("Received audioDeviceSelected message:",e),x&&e.context==="input"){console.log("Shared mode: Audio input device selection ignored.");break}const{context:f,deviceId:_}=e;if(!_){console.warn("Received audioDeviceSelected message without a deviceId.");break}f==="input"?(Ae=_,Y&&(Be(),setTimeout(si,150))):f==="output"?(De=_,St()):console.warn(`Unknown context in audioDeviceSelected message: ${f}`);break;case"gamepadControl":console.log(`Received gamepad control message: enabled=${e.enabled}`);const w=e.enabled;re!==w&&(re=w,V("isGamepadEnabled",re),Ee(),window.webrtcInput&&window.webrtcInput.gamepadManager?x?(window.webrtcInput.gamepadManager.enable(),console.log("Shared mode: Gamepad control message received, ensuring its GamepadManager remains active for polling.")):re?(window.webrtcInput.gamepadManager.enable(),console.log("Primary mode: Gamepad toggle ON. Enabling GamepadManager polling.")):(window.webrtcInput.gamepadManager.disable(),console.log("Primary mode: Gamepad toggle OFF. Disabling GamepadManager polling.")):console.warn("Client: window.webrtcInput.gamepadManager not found in 'gamepadControl' message handler."));break;case"requestFullscreen":vi();break;case"command":if(x){console.log("Shared mode: Arbitrary command sending to server blocked.");break}if(typeof e.value=="string"){const K=e.value;if(console.log(`Received 'command' message with value: "${K}". Forwarding to WebSocket.`),d&&d.readyState===WebSocket.OPEN)try{d.send(`cmd,${K}`),console.log(`Sent command to server via WebSocket: cmd,${K}`)}catch(X){console.error("Failed to send command via WebSocket:",X)}else console.warn("Cannot send command: WebSocket is not open or not available.")}else console.warn("Received 'command' message without a string value:",e);break;case"touchinput:trackpad":window.webrtcInput&&typeof window.webrtcInput.setTrackpadMode=="function"&&(Oe=!0,V("trackpadMode",!0),window.webrtcInput.setTrackpadMode(!0),d&&d.readyState===WebSocket.OPEN&&d.send("SET_NATIVE_CURSOR_RENDERING,1"));break;case"touchinput:touch":window.webrtcInput&&typeof window.webrtcInput.setTrackpadMode=="function"&&(Oe=!1,V("trackpadMode",!1),window.webrtcInput.setTrackpadMode(!1),d&&d.readyState===WebSocket.OPEN&&d.send("SET_NATIVE_CURSOR_RENDERING,0"));break}}async function Kt(t,e="text/plain"){if(!d||d.readyState!==WebSocket.OPEN){console.warn("Cannot send clipboard data: WebSocket is not open.");return}const i=t instanceof ArrayBuffer||t instanceof Uint8Array;let s;if(i?s=new Uint8Array(t):(s=new TextEncoder().encode(t),e="text/plain"),s.byteLength<Dt){let n="";for(let c=0;c<s.length;c++)n+=String.fromCharCode(s[c]);const l=btoa(n);e==="text/plain"?(d.send(`cw,${l}`),console.log("Sent small clipboard text in single message.")):(d.send(`cb,${e},${l}`),console.log(`Sent small binary clipboard data in single message: ${e}`))}else{console.log(`Sending large clipboard data (${s.byteLength} bytes) in multiple parts.`);const n=s.byteLength;e==="text/plain"?d.send(`cws,${n}`):d.send(`cbs,${e},${n}`);for(let l=0;l<n;l+=Dt){const c=s.subarray(l,l+Dt);let p="";for(let b=0;b<c.length;b++)p+=String.fromCharCode(c[b]);const h=btoa(p);e==="text/plain"?d.send(`cwd,${h}`):d.send(`cbd,${h}`),await new Promise(b=>setTimeout(b,0))}e==="text/plain"?d.send("cwe"):d.send("cbe"),console.log("Finished sending multi-part clipboard data.")}}function di(t){console.log("Applying settings:",t);let e=!1;if(t.framerate!==void 0&&(st=parseInt(t.framerate),$("framerate",st),e=!0),t.encoder!==void 0){const i=t.encoder;k!==i&&(k=i,ht("encoder",k),e=!0,(i==="jpeg"||i==="x264enc"||i==="x264enc-striped")&&v&&v.state!=="closed"&&(console.log(`Switching to ${i}, closing main video decoder.`),v.close(),v=null),i!=="x264enc-striped"&&we())}if(t.h264_crf!==void 0&&(at=parseInt(t.h264_crf,10),$("h264_crf",at),e=!0),t.h264_fullcolor!==void 0&&(rt=!!t.h264_fullcolor,V("h264_fullcolor",rt),e=!0),t.h264_streaming_mode!==void 0&&(lt=!!t.h264_streaming_mode,V("h264_streaming_mode",lt),e=!0),t.jpeg_quality!==void 0&&(ct=parseInt(t.jpeg_quality,10),$("jpeg_quality",ct),e=!0),t.paint_over_jpeg_quality!==void 0&&(dt=parseInt(t.paint_over_jpeg_quality,10),$("paint_over_jpeg_quality",dt),e=!0),t.use_cpu!==void 0&&(vt=!!t.use_cpu,V("use_cpu",vt),e=!0),t.h264_paintover_crf!==void 0&&(ut=parseInt(t.h264_paintover_crf,10),$("h264_paintover_crf",ut),e=!0),t.h264_paintover_burst_frames!==void 0&&(ft=parseInt(t.h264_paintover_burst_frames,10),$("h264_paintover_burst_frames",ft),e=!0),t.use_paint_over_quality!==void 0&&(Ft=!!t.use_paint_over_quality,V("use_paint_over_quality",Ft),e=!0),t.scaling_dpi!==void 0&&(kt=parseInt(t.scaling_dpi,10),$("scaling_dpi",kt),e=!0),t.enable_binary_clipboard!==void 0&&(We=!!t.enable_binary_clipboard,V("enable_binary_clipboard",We),e=!0),t.use_css_scaling!==void 0){const i={type:"setUseCssScaling",value:!!t.use_css_scaling};ci({origin:window.location.origin,data:i})}if(t.use_browser_cursors!==void 0&&(Me=!!t.use_browser_cursors,V("use_browser_cursors",Me),It()),t.debug!==void 0){it=t.debug,V("debug",it),console.log(`Applied debug setting: ${it}. Reloading...`),setTimeout(()=>{window.location.reload()},700);return}e&&Pi("handleSettingsMessage")}function Ri(){const t={gpu:Si,cpu:Ki,network:ki,clientFps:window.fps,audioBuffer:window.currentAudioBufferSize,videoBuffer:$e.length,isVideoPipelineActive:N,isAudioPipelineActive:H,isMicrophoneActive:Y};t.encoderName=k,t.h264_fullcolor=rt,t.h264_streaming_mode=lt,window.parent.postMessage({type:"stats",data:t},window.location.origin),console.log("Sent stats message via window.postMessage:",t)}function Ze(){clearTimeout(Xt),Xt=setTimeout(()=>{console.warn(`Shared mode (${le}): Timeout waiting for video identification packet (attempt ${de+1}/${ni}).`),de++,de<ni?P==="awaiting_identification"?(console.log(`Shared mode (${le}): Probing timeout. Attempting to re-trigger stream with STOP/START_VIDEO.`),d&&d.readyState===WebSocket.OPEN&&(d.send("STOP_VIDEO"),setTimeout(()=>{d&&d.readyState===WebSocket.OPEN&&(d.send("START_VIDEO"),console.log(`Shared mode (${le}): Sent START_VIDEO after probing timeout.`))},250)),Ze()):console.log(`Shared mode: Probing timeout fired but state is ${P}. Not retrying automatically.`):(console.error("Shared mode: Failed to identify video type after multiple attempts. Entering error state. Stream may not be active or correctly configured on server/primary client."),P="error",F&&(F.textContent="Error: Could not identify video stream.",F.classList.remove("hidden")))},yi)}function mt(){clearTimeout(Xt),Xt=null}document.addEventListener("DOMContentLoaded",()=>{async function t(){Tt=!1,v&&v.state!=="closed"&&(console.warn("VideoDecoder already exists, closing before re-initializing."),v.close());let r=1024,a=768;if(x)r=m>0?m:1024,a=y>0?y:768;else if(window.is_manual_resolution_mode&&m!=null&&y!=null)r=m,a=y;else if(window.webrtcInput&&typeof window.webrtcInput.getWindowResolution=="function")try{const K=window.webrtcInput.getWindowResolution(),X=C(K[0]),D=C(K[1]);X>0&&D>0&&(r=X,a=D)}catch{}const u=q?1:window.devicePixelRatio||1,f=C(r*u),_=C(a*u);v=new VideoDecoder({output:s,error:K=>Ge(K,"main_decoder")});const w={codec:"avc1.42E01E",codedWidth:f,codedHeight:_,optimizeForLatency:!0,hardwareAcceleration:"prefer-software"};try{if(!(await VideoDecoder.isConfigSupported(w)).supported)throw new Error(`Configuration not supported: ${JSON.stringify(w)}`);return await v.configure(w),console.log("Main VideoDecoder configured successfully with config:",w),!0}catch(K){return Ge(K,"main_decoder_configure"),!1}}if(!zi())return;const e=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1);window.addEventListener("focus",async()=>{if(!(x||!window.clipboard_enabled))if(!We)navigator.clipboard.readText().then(r=>{r&&(Kt(r),console.log("Sent clipboard text on focus via sendClipboardData"))}).catch(r=>{r.name!=="NotFoundError"&&!r.message.includes("not focused")&&console.warn(`Could not read text clipboard on focus: ${r.name} - ${r.message}`)});else try{const r=await navigator.clipboard.read();if(!r||r.length===0)return;const a=r[0],u=a.types.find(f=>f.startsWith("image/"));if(u){const f=await a.getType(u),_=await f.arrayBuffer();Kt(_,u),console.log(`Sent binary clipboard on focus via sendClipboardData: ${u}, size: ${f.size} bytes`)}else if(a.types.includes("text/plain")){const _=await(await a.getType("text/plain")).text();if(!_)return;Kt(_),console.log("Sent clipboard text (from binary-enabled path) on focus via sendClipboardData")}}catch(r){r.name!=="NotFoundError"&&!r.message.includes("not focused")&&console.warn(`Could not read clipboard using advanced API on focus: ${r.name} - ${r.message}`)}}),document.addEventListener("visibilitychange",async()=>{if(x){console.log("Shared mode: Tab visibility changed, stream control bypassed. Current state:",document.hidden?"hidden":"visible");return}if(document.hidden){if(console.log("Tab is hidden, stopping video pipeline if active."),d&&d.readyState===WebSocket.OPEN&&N&&(d.send("STOP_VIDEO"),N=!1,window.postMessage({type:"pipelineStatusUpdate",video:!1},window.location.origin),console.log("Tab hidden: Sent STOP_VIDEO. Clearing canvas visually. Server will send PIPELINE_RESETTING for full state reset."),M&&g))try{M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)}catch(r){console.error("Error clearing canvas on tab hidden:",r)}}else if(console.log("Tab is visible, requesting video pipeline start if it was inactive."),d&&d.readyState===WebSocket.OPEN&&!N&&(d.send("START_VIDEO"),Xe===null&&(console.log("Tab is visible again, re-acquiring Wake Lock."),await Vt()),N=!0,window.postMessage({type:"pipelineStatusUpdate",video:!0},window.location.origin),console.log("Tab visible: Sent START_VIDEO. Clearing canvas visually. Server will send PIPELINE_RESETTING for full state reset."),M&&g))try{M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)}catch(r){console.error("Error clearing canvas on tab visible/start:",r)}});async function i(r,a){if(typeof ImageDecoder>"u"){console.warn("ImageDecoder API not supported. Cannot decode JPEG stripes.");return}try{const u=new ImageDecoder({data:a,type:"image/jpeg"}),f=await u.decode();xe.push({image:f.image,startY:r}),u.close()}catch(u){console.error("Error decoding JPEG stripe:",u,"startY:",r,"dataLength:",a.byteLength)}}function s(r){const a=k!=="jpeg"&&k!=="x264enc-striped"&&k!=="x264enc"&&!x||x&&W==="h264_full_frame";if(document.hidden&&a){r.close();return}if(!x&&xt==="websockets"&&!N){r.close();return}if(x&&W==="h264_full_frame"&&P==="ready"){const u=r.codedWidth,f=r.codedHeight,_=u/dpr,w=f/dpr;(m!==_||y!==w)&&_>0&&w>0&&(m=_,y=w,console.log(`Shared mode (decoded H264): Updated manual (logical) dimensions from H.264 frame to ${m.toFixed(2)}x${y.toFixed(2)} (Physical: ${u}x${f})`),z(m,y,!0))}a?$e.push(r):(console.warn(`[handleDecodedFrame] Frame received but not for a GStreamer H.264 mode that uses videoFrameBuffer. isSharedMode: ${x}, currentEncoderMode: ${k}, identifiedEncoderModeForShared: ${W}. Closing frame to be safe.`),r.close())}et=t,console.log("initializeDecoder function assigned to triggerInitializeDecoder.");function n(){if(!g||!M){requestAnimationFrame(n);return}const r=x?1:window.devicePixelRatio||1,a=q?1:r;if(x&&m&&y&&m>0&&y>0){const f=C(m*r),_=C(y*r);(g.width!==f||g.height!==_)&&(console.log(`Shared mode (paintVideoFrame): Canvas buffer ${g.width}x${g.height} out of sync with expected physical ${f}x${_} (logical: ${m}x${y}). Re-applying style.`),z(m,y,!0))}let u=!1;if(k==="x264enc"||k==="x264enc-striped"){if(x&&P==="ready"&&ke.length>0){const _=ke[0].frame;if(_&&_.codedWidth>0){const w=_.codedWidth,K=w/a;if(m!==K&&K>0){if(m>0&&y>0){const X=K/m;y=C(y*X)}m=K,console.log(`Shared mode (VNC stripe paint): Updated manual (logical) Width from VNC stripe to ${m.toFixed(2)} (Stripe Coded: ${w}, DPR for conversion: ${a})`),y&&m>0&&y>0&&z(m,y,!0)}}}let f=!1;for(const _ of ke)g.width>0&&g.height>0&&M.drawImage(_.frame,0,_.yPos),_.frame.close(),f=!0;ke=[],f&&!Ne&&Lt()}else if(k==="jpeg"){if(M&&xe.length>0){if(x&&P==="ready"&&xe.length>0){const f=xe[0].image;if(f&&f.codedWidth>0){const _=f.codedWidth,w=_/a;if(m!==w&&w>0){if(m>0&&y>0){const K=w/m;y=C(y*K)}m=w,console.log(`Shared mode (JPEG stripe paint): Updated manual (logical) Width from JPEG stripe to ${m.toFixed(2)} (Image Coded: ${_}, DPR for conversion: ${a})`),y&&m>0&&y>0&&z(m,y,!0)}}}if(g.width===0||g.height===0||g.width===300&&g.height===150){const f=xe[0];f&&f.image&&(f.startY+f.image.height>g.height||f.image.width>g.width)&&console.warn(`[paintVideoFrame] Canvas dimensions (${g.width}x${g.height}) may be too small for JPEG stripes.`)}for(;xe.length>0;){const f=xe.shift();if(f&&f.image)try{g.width>0&&g.height>0&&M.drawImage(f.image,0,f.startY),f.image.close(),u=!0}catch(_){if(console.error("[paintVideoFrame] Error drawing JPEG segment:",_,f),f.image&&typeof f.image.close=="function")try{f.image.close()}catch{}}}u&&(Fe++,Ne||(Lt(),!Ue&&!x&&Ve()))}}else if((x&&k==="h264_full_frame"&&P==="ready"||!x&&k!=="jpeg"&&k!=="x264enc"&&k!=="x264enc-striped")&&(!document.hidden||x&&P==="ready")&&(x&&P==="ready"||!x&&N)&&$e.length>0){const _=$e.shift();_&&(g.width>0&&g.height>0&&M.drawImage(_,0,0),_.close(),Fe++,Ne||(Lt(),!Ue&&!x&&Ve()))}requestAnimationFrame(n)}async function l(){if(E!=="primary"){console.log("Secondary display: Audio pipeline initialization skipped.");return}if(!A){const r={sampleRate:48e3};A=new(window.AudioContext||window.webkitAudioContext)(r),console.log("Playback AudioContext initialized. Actual sampleRate:",A.sampleRate,"Initial state:",A.state),A.onstatechange=()=>{console.log(`Playback AudioContext state changed to: ${A.state}`),A.state==="running"&&St()}}try{const r=`
        class AudioFrameProcessor extends AudioWorkletProcessor {
            constructor(options) {
                super();
                this.audioBufferQueue = [];
                this.currentAudioData = null;
                this.currentDataOffset = 0;

                this.TARGET_BUFFER_PACKETS = 3;
                this.MAX_BUFFER_PACKETS = 8;

                this.port.onmessage = (event) => {
                    if (event.data.audioData) {
                        const pcmData = new Float32Array(event.data.audioData);
                        if (this.audioBufferQueue.length >= this.MAX_BUFFER_PACKETS) {
                            this.audioBufferQueue.shift();
                        }
                        this.audioBufferQueue.push(pcmData);
                    } else if (event.data.type === 'getBufferSize') {
                        const bufferMillis = this.audioBufferQueue.reduce((total, buf) => total + (buf.length / 2 / sampleRate) * 1000, 0);
                        this.port.postMessage({
                            type: 'audioBufferSize',
                            size: this.audioBufferQueue.length,
                            durationMs: bufferMillis
                        });
                    }
                };
            }

            process(inputs, outputs, parameters) {
                const output = outputs[0];
                const leftChannel = output ? output[0] : undefined;

                if (!leftChannel) {
                    return true;
                }
                
                const rightChannel = output ? output[1] : leftChannel;
                const samplesPerBuffer = leftChannel.length;

                if (this.audioBufferQueue.length === 0 && this.currentAudioData === null) {
                    leftChannel.fill(0);
                    rightChannel.fill(0);
                    return true;
                }

                let data = this.currentAudioData;
                let offset = this.currentDataOffset;

                for (let sampleIndex = 0; sampleIndex < samplesPerBuffer; sampleIndex++) {
                    if (!data || offset >= data.length) {
                        if (this.audioBufferQueue.length > 0) {
                            data = this.currentAudioData = this.audioBufferQueue.shift();
                            offset = this.currentDataOffset = 0;
                        } else {
                            this.currentAudioData = null;
                            this.currentDataOffset = 0;
                            leftChannel.fill(0, sampleIndex);
                            rightChannel.fill(0, sampleIndex);
                            return true;
                        }
                    }
                    
                    leftChannel[sampleIndex] = data[offset++];
                    if (offset < data.length) {
                        rightChannel[sampleIndex] = data[offset++];
                    } else {
                        rightChannel[sampleIndex] = leftChannel[sampleIndex];
                    }
                }

                this.currentDataOffset = offset;
                if (data && offset >= data.length) {
                    this.currentAudioData = null;
                    this.currentDataOffset = 0;
                }

                return true;
            }
        }
        registerProcessor('audio-frame-processor', AudioFrameProcessor);
      `,a=new Blob([r],{type:"text/javascript"}),u=URL.createObjectURL(a);await A.audioWorklet.addModule(u),URL.revokeObjectURL(u),je=new AudioWorkletNode(A,"audio-frame-processor",{numberOfOutputs:1,outputChannelCount:[2]}),pe=je.port,pe.onmessage=w=>{w.data.type==="audioBufferSize"&&(window.currentAudioBufferSize=w.data.size,window.currentAudioBufferDuration=w.data.durationMs)},_e=A.createGain(),_e.gain.value=wt,je.connect(_e),_e.connect(A.destination),console.log("Playback AudioWorkletProcessor initialized and connected through a GainNode for volume control."),await St(),await St(),T&&(console.warn("[Main] Terminating existing audio decoder worker before creating a new one."),T.postMessage({type:"close"}),await new Promise(w=>setTimeout(w,50)),T&&T.terminate(),T=null);const f=new Blob([$i],{type:"application/javascript"}),_=URL.createObjectURL(f);T=new Worker(_),URL.revokeObjectURL(_),T.onmessage=w=>{const{type:K,reason:X,message:D}=w.data;if(K==="decoderInitFailed")console.error(`[Main] Audio Decoder Worker failed to initialize: ${X}`);else if(K==="decoderError")console.error(`[Main] Audio Decoder Worker reported error: ${D}`);else if(K==="decoderInitialized")console.log("[Main] Audio Decoder Worker confirmed its decoder is initialized.");else if(K==="decodedAudioData"){const R=w.data.pcmBuffer;R&&pe&&A&&A.state==="running"&&window.currentAudioBufferSize<10&&pe.postMessage({audioData:R},[R])}},T.onerror=w=>{console.error("[Main] Uncaught error in Audio Decoder Worker:",w.message,w),T&&(T.terminate(),T=null)},pe?(T.postMessage({type:"init",data:{initialPipelineStatus:H}}),console.log("[Main] Audio Decoder Worker created and init message sent.")):console.error("[Main] audioWorkletProcessorPort is null, cannot initialize audioDecoderWorker correctly.")}catch(r){console.error("Error initializing Playback AudioWorklet:",r),A&&A.state!=="closed"&&A.close(),A=null,je=null,pe=null}}async function c(){T?(console.log("[Main] Requesting Audio Decoder Worker to reinitialize its decoder."),T.postMessage({type:"reinitialize"})):(console.warn("[Main] Cannot initialize decoder audio: Audio Decoder Worker not available. Call initializeAudio() first."),xt==="websockets"&&!A&&(console.log("[Main] Audio context missing, attempting to initialize full audio pipeline for websockets."),await l()))}const p=location.protocol==="http:"?"ws://":"wss://";let h=new URL(`${p}${window.location.host}${e}`);qe&&(h.search=`?token=${ri}`),h.pathname+="websockets",d=new WebSocket(h.href),d.binaryType="arraybuffer";const b=()=>{if(d&&d.readyState===WebSocket.OPEN)try{ge!==-1&&d.send(`CLIENT_FRAME_ACK ${ge}`)}catch(r){console.error("[Backpressure] Error sending frame ACK:",r)}},S=()=>{if(!x&&ai){const r=performance.now(),a=r-_t,u=r-Qe,f=1e3;if(gt.size>0){if(a>=f){const _=gt.size*1e3/a;window.fps=Math.round(_),gt.clear(),_t=r,Fe=0,Qe=r}}else if(Fe>0){if(u>=f){const _=Fe*1e3/u;window.fps=Math.round(_),Fe=0,Qe=r,_t=r}}else(a>=f||u>=f)&&(window.fps=0,Qe=r,_t=r);pe&&pe.postMessage({type:"getBufferSize"})}};d.onopen=()=>{if(console.log("[websockets] Connection opened!"),Re="connected_waiting_mode",Ke="Connection established. Waiting for server mode...",Ce(),window.postMessage({type:"trackpadModeUpdate",enabled:Oe},window.location.origin),x)console.log("Shared mode: WebSocket opened. Waiting for 'MODE websockets' from server to start identification sequence.");else{const r=`${ye}_`,a={},u=q?1:window.devicePixelRatio||1,f={},_=["framerate","h264_crf","encoder","is_manual_resolution_mode","audio_bitrate","h264_fullcolor","h264_streaming_mode","jpeg_quality","paint_over_jpeg_quality","use_cpu","h264_paintover_crf","h264_paintover_burst_frames","use_paint_over_quality","scaling_dpi","enable_binary_clipboard"],w=["is_manual_resolution_mode","h264_fullcolor","h264_streaming_mode","use_cpu","use_paint_over_quality","enable_binary_clipboard"],K=["framerate","h264_crf","audio_bitrate","jpeg_quality","paint_over_jpeg_quality","h264_paintover_crf","h264_paintover_burst_frames","scaling_dpi"];for(const X in localStorage)if(Object.hasOwnProperty.call(localStorage,X)&&X.startsWith(r)){const D=X.substring(r.length),R=`_${E}`,ue=E!=="primary"&&D.endsWith(R),be=ue?D.slice(0,-R.length):D;if(!ue&&f[be])continue;if(_.includes(be)){if(!ue&&f[be])continue;let O=localStorage.getItem(X);if(w.includes(be))O=O==="true";else if(K.includes(be)&&(O=parseInt(O,10),isNaN(O)))continue;a[be]=O,ue&&(f[be]=!0)}}if(is_manual_resolution_mode&&m!=null&&y!=null)a.is_manual_resolution_mode=!0,a.manual_width=C(m*u),a.manual_height=C(y*u);else{const X=document.querySelector(".video-container"),D=X?X.getBoundingClientRect():{width:window.innerWidth,height:window.innerHeight};a.is_manual_resolution_mode=!1,a.initialClientWidth=C(D.width*u),a.initialClientHeight=C(D.height*u)}a.useCssScaling=q,a.displayId=E,E==="display2"&&(a.displayPosition=zt);try{const D=`SETTINGS,${JSON.stringify(a)}`;d.send(D),console.log("[websockets] Sent initial settings (resolutions are physical) to server:",a)}catch(X){console.error("[websockets] Error constructing or sending initial settings:",X)}}d.send("cr"),console.log("[websockets] Sent initial clipboard request (cr) to server."),N=!0,H=E==="primary",window.postMessage({type:"pipelineStatusUpdate",video:!0,audio:H},window.location.origin),x||(Y=!1,te===null&&(te=setInterval(S,ti),console.log(`[websockets] Started sending client metrics every ${ti}ms.`)),se===null&&(se=setInterval(b,ii),console.log(`[websockets] Started sending backpressure ACKs every ${ii}ms.`)))},d.onmessage=r=>{if(r.data instanceof ArrayBuffer){const a=r.data,u=new DataView(a);if(a.byteLength<1)return;const f=u.getUint8(0);if(x){if(P==="awaiting_identification"){let _=null;if(f===0?_="h264_full_frame":f===3?_="jpeg":f===4&&(_="x264enc-striped"),_){if(mt(),de=0,W=_,console.log(`Shared mode: Identified video encoding type as '${W}' from first packet (type 0x${f.toString(16)}). State: configuring.`),P="configuring",console.log("Shared mode: Cleaning up existing video pipeline elements for reconfiguration."),v&&v.state!=="closed"){try{v.close()}catch(w){console.warn("Shared mode: Error closing main H.264 decoder during cleanup:",w)}v=null}we(),ot(),nt(),ke=[],M&&g&&(console.log("Shared mode: Resetting canvas display."),M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)),k=W,console.log(`Shared mode: Set global currentEncoderMode to '${k}'.`),W==="h264_full_frame"?(console.log("Shared mode: Initializing main H.264 decoder for the identified type."),et().then(w=>{w?(console.log("Shared mode: H.264 decoder configured. Requesting fresh video stream."),P="ready",console.log(`Shared mode: Client is now ready to process video of type '${W}'.`)):(console.error("Shared mode: Main H.264 decoder failed to initialize or configure. Entering error state."),P="error")}).catch(w=>{console.error("Shared mode: Exception during H.264 decoder initialization. Entering error state.",w),P="error"})):(W==="jpeg"||W==="x264enc-striped")&&(console.log(`Shared mode: Configured for ${W}. Specific decoders (if any) are managed on-demand or not needed centrally.`),m&&y&&m>0&&y>0&&z(m,y,!0),console.log("Shared mode: Reconfiguration process for non-H264 initiated. Requesting fresh video stream from server."),P="ready",console.log(`Shared mode: Client is now ready to process video of type '${W}'.`))}else if(f!==1){console.warn(`Shared mode (awaiting_identification): Received non-identifying binary packet type 0x${f.toString(16)}. Still waiting for a video packet.`);return}}else if(P==="ready"){if(f===0||f===3||f===4){let w=!1;if((W==="h264_full_frame"&&f===0||W==="jpeg"&&f===3||W==="x264enc-striped"&&f===4)&&(w=!0),!w){console.warn(`Shared mode (ready): Received video packet type 0x${f.toString(16)} which does NOT match identified type '${W}'. Discarding packet.`);return}}}else if((P==="configuring"||P==="error"||P==="idle")&&(f===0||f===3||f===4)){console.log(`Shared mode: Video packet (type 0x${f.toString(16)}) received while in state '${P}'. Discarding.`);return}}if(f===0){const _=x?2:4;if(a.byteLength<_)return;const w=u.getUint8(1);x||(ge=u.getUint16(2,!1));const K=a.slice(_);if(x&&P==="ready"&&k==="h264_full_frame"||!x&&N&&k!=="jpeg"&&k!=="x264enc"&&k!=="x264enc-striped"){if(x&&!Je)if(w===1)console.log("Shared mode: First keyframe received. Opening the gate for video decoding."),Je=!0;else{console.log("Shared mode: Gate is closed. Discarding non-keyframe packet.");return}if(v&&v.state==="configured"){const D=w===1?"key":"delta";if(D==="delta"&&!Tt)return;D==="key"&&(Tt=!0);const R=new EncodedVideoChunk({type:w===1?"key":"delta",timestamp:performance.now()*1e3,data:K});try{v.decode(R)}catch(ue){Ge(ue,"main_decoder_decode")}}else!x&&(!v||v.state==="closed"||v.state==="unconfigured")?(console.warn(`Main decoder not ready for Full H.264 frame (mode: ${k}, state: ${v?v.state:"null"}). Attempting init. Frame might be dropped.`),t()):x&&(!v||v.state==="closed"||v.state==="unconfigured")?(console.error(`Shared mode: Main H.264 decoder not available or not configured when expected. State: ${P}. Decoder state: ${v?v.state:"null"}. Entering error state.`),P="error"):console.warn(`Main decoder exists but not configured (state: ${v.state}). Full H.264 frame dropped.`)}}else if(f===1){if(E!=="primary")return;const _=2;if(a.byteLength<_)return;if(H||x)if(T){A&&A.state!=="running"&&A.resume().catch(K=>console.error("Error resuming audio context",K));const w=a.slice(_);if(w.byteLength>0){if(!x&&window.currentAudioBufferSize>=5)return;T.postMessage({type:"decode",data:{opusBuffer:w,timestamp:performance.now()*1e3}},[w])}}else console.warn("AudioDecoderWorker not ready. Attempting to initialize audio pipeline."),l().then(()=>{if(T){const w=a.slice(_);if(w.byteLength>0){if(!x&&window.currentAudioBufferSize>=5)return;T.postMessage({type:"decode",data:{opusBuffer:w,timestamp:performance.now()*1e3}},[w])}}})}else if(f===3){const _=x?4:6;if(a.byteLength<_)return;x||(ge=u.getUint16(2,!1));const w=u.getUint16(x?2:4,!1),K=a.slice(_);if(x&&P==="ready"&&k==="jpeg"||!x&&N&&k==="jpeg"){if(K.byteLength===0)return;i(w,K)}}else if(f===4){if(a.byteLength<10)return;const w=u.getUint8(1),K=u.getUint16(2,!1);x||(ge=K,gt.add(ge));const X=u.getUint16(4,!1),D=u.getUint16(6,!1),R=u.getUint16(8,!1),ue=a.slice(10);if(x&&P==="ready"&&(k==="x264enc"||k==="x264enc-striped")||!x&&N&&(k==="x264enc"||k==="x264enc-striped")){if(x&&!Je)if(w===1)console.log("Shared mode: First keyframe received for striped video. Opening the gate."),Je=!0;else{console.log("Shared mode: Gate is closed. Discarding non-keyframe striped packet.");return}if(ue.byteLength===0)return;let O=oe[X];const Et=w===1?"key":"delta";if(Et==="delta"&&(!O||!O.hasReceivedKeyframe))return;if(!O||O.decoder.state==="closed"||O.decoder.state==="configured"&&(O.width!==D||O.height!==R)){if(O&&O.decoder.state!=="closed")try{O.decoder.close()}catch(fe){console.warn("Error closing old VNC stripe decoder:",fe)}const ve=new VideoDecoder({output:Ti.bind(null,X,K),error:fe=>Ge(fe,`stripe_decoder_Y=${X}`)}),Te={codec:"avc1.42E01E",codedWidth:D,codedHeight:R,optimizeForLatency:!0};oe[X]={decoder:ve,pendingChunks:[],width:D,height:R,hasReceivedKeyframe:!1},O=oe[X],VideoDecoder.isConfigSupported(Te).then(fe=>fe.supported?ve.configure(Te):(console.error(`VNC stripe decoder config not supported for Y=${X}:`,Te),delete oe[X],Promise.reject("Config not supported"))).then(()=>{Ei(X)}).catch(fe=>{if(console.error(`Error configuring VNC stripe decoder Y=${X}:`,fe),oe[X]&&oe[X].decoder===ve){try{ve.state!=="closed"&&ve.close()}catch{}delete oe[X]}})}if(O){Et==="key"&&(O.hasReceivedKeyframe=!0);const ve=performance.now()*1e3,Te={type:Et,timestamp:ve,data:ue};if(O.decoder.state==="configured"){const fe=new EncodedVideoChunk(Te);try{O.decoder.decode(fe)}catch(Yt){Ge(Yt,`stripe_decode_Y=${X}`)}}else O.decoder.state==="unconfigured"||O.decoder.state==="configuring"?O.pendingChunks.push(Te):console.warn(`VNC stripe decoder for Y=${X} in unexpected state: ${O.decoder.state}. Dropping chunk.`)}}}else console.warn("Unknown binary data payload type received:",f)}else if(typeof r.data=="string"){if(r.data.startsWith("KILL ")){const a=r.data.substring(5);console.error(`Received KILL message from server: ${a}`),ce&&clearInterval(ce),d&&(d.onclose=()=>{},d.close()),F&&(F.textContent=`Connection Terminated: ${a}`,F.classList.remove("hidden"));return}if(r.data.startsWith("AUTH_SUCCESS,")){const a=r.data.substring(13),u=JSON.parse(a);Z=u.role,L=u.slot,console.log(`Authentication successful. Received Role: ${Z}, Slot: ${L}`),window.postMessage({type:"clientRoleUpdate",role:Z},window.location.origin),Z==="viewer"&&(console.log("Token-based client is a 'viewer'. Applying shared mode compatibility settings."),x=!0,window.webrtcInput&&window.webrtcInput.setSharedMode(!0),le="shared",L!==null&&L>0?ie=L-1:ie=void 0,(!m||m<=0||!y||y<=0)&&(m=1280,y=720),z(m,y,!0),window.addEventListener("resize",()=>{x&&m&&y&&m>0&&y>0&&z(m,y,!0)}),Ut(),yt&&(console.log("Post-init sync: Forcing shared mode state because 'MODE websockets' was handled before auth."),P="awaiting_identification",de=0,W=null,d&&d.readyState===WebSocket.OPEN&&(d.send("STOP_VIDEO"),setTimeout(()=>{d&&d.readyState===WebSocket.OPEN&&(d.send("START_VIDEO"),console.log("Shared mode: Sent START_VIDEO after initial STOP_VIDEO."))},250)),Ze()))}if(r.data.startsWith("AUTH_SUCCESS,")){const a=r.data.substring(13),u=JSON.parse(a);Z=u.role,L=u.slot,console.log(`Authentication successful. Received Role: ${Z}, Slot: ${L}`),window.postMessage({type:"clientRoleUpdate",role:Z},window.location.origin),window.webrtcInput&&typeof window.webrtcInput.updateControllerSlot=="function"&&window.webrtcInput.updateControllerSlot(L),Z==="viewer"&&(console.log("Token-based client is a 'viewer'. Applying shared mode compatibility settings."),x=!0,le="shared",L!==null&&L>0?ie=L-1:ie=void 0,(!m||m<=0||!y||y<=0)&&(m=1280,y=720),z(m,y,!0),window.addEventListener("resize",()=>{x&&m&&y&&m>0&&y>0&&z(m,y,!0)}),Ut(),yt&&(console.log("Post-init sync: Forcing shared mode state because 'MODE websockets' was handled before auth."),P="awaiting_identification",de=0,W=null,d&&d.readyState===WebSocket.OPEN&&(d.send("STOP_VIDEO"),setTimeout(()=>{d&&d.readyState===WebSocket.OPEN&&(d.send("START_VIDEO"),console.log("Shared mode: Sent START_VIDEO after initial STOP_VIDEO to sync stream."))},250)),Ze()))}if(r.data.startsWith("MK_ACCESS,")){const u=parseInt(r.data.split(",")[1])===1;console.log(`Received MK_ACCESS update: ${u}`),window.webrtcInput&&(u?window.webrtcInput.isInputAttached()||(console.log("MK Access Granted: Attaching input context."),window.webrtcInput.attach_context()):(console.log("MK Access Revoked: Detaching input context."),window.webrtcInput.detach_context()))}if(r.data.startsWith("ROLE_UPDATE,")){let a;try{const f=r.data.substring(12);a=JSON.parse(f)}catch(f){console.error("Failed to parse ROLE_UPDATE message:",f);return}console.log(`Received role update. New role: ${a.role}, New slot: ${a.slot}`);const u=L;Z=a.role,L=a.slot,window.webrtcInput&&typeof window.webrtcInput.updateControllerSlot=="function"&&window.webrtcInput.updateControllerSlot(L),u!==null&&L===null?window.webrtcInput&&window.webrtcInput.gamepadManager&&(console.log("Controller slot revoked, disabling gamepad polling."),window.webrtcInput.gamepadManager.disable()):u===null&&L!==null&&(window.webrtcInput&&window.webrtcInput.gamepadManager&&re?(console.log("Controller slot granted and global gamepad toggle is ON. Enabling gamepad polling."),window.webrtcInput.gamepadManager.enable()):window.webrtcInput&&window.webrtcInput.gamepadManager&&console.log("Controller slot granted, but global gamepad toggle is OFF. Polling remains disabled."))}if(r.data==="MODE websockets"){if(xt="websockets",console.log("[websockets] Switched to websockets mode."),Re="initializing",Ke="Initializing WebSocket mode...",Ce(),!qe){const a=window.location.hash;a==="#shared"?(Z="viewer",L=null,L!==null&&(ie=L-1)):a.startsWith("#player")?(Z="viewer",L=parseInt(a.substring(7),10)||null):(Z="controller",L=1,Z="controller",L=1,ie=0),console.log(`Legacy mode detected. Role from hash: ${Z}, Slot: ${L}`),Ve()}if(v&&v.state!=="closed"){try{v.close()}catch{}v=null}we(),ot(),nt(),ke=[],x||(Be(),qe||Ve(),k!=="jpeg"&&k!=="x264enc"&&k!=="x264enc-striped"&&t()),l().then(()=>{c()}),qe&&Ve(),window.webrtcInput&&typeof window.webrtcInput.setTrackpadMode=="function"&&window.webrtcInput.setTrackpadMode(Oe),Oe&&d&&d.readyState===WebSocket.OPEN&&(d.send("SET_NATIVE_CURSOR_RENDERING,1"),console.log("[websockets] Applied trackpad mode on initialization.")),J&&J.classList.add("hidden"),F&&F.classList.remove("hidden"),requestAnimationFrame(n),x?(P="awaiting_identification",de=0,W=null,console.log("Shared mode: Received 'MODE websockets'. Requesting initial stream with STOP/START_VIDEO. State: awaiting_identification."),d&&d.readyState===WebSocket.OPEN&&(d.send("STOP_VIDEO"),setTimeout(()=>{d&&d.readyState===WebSocket.OPEN&&(d.send("START_VIDEO"),console.log("Shared mode: Sent START_VIDEO after initial STOP_VIDEO."))},250)),Ze()):d&&d.readyState===WebSocket.OPEN&&H&&d.send("START_AUDIO"),Ke="Waiting for stream...",Ce(),yt=!0}else if(xt==="websockets")if(r.data.startsWith("{")){let a;try{a=JSON.parse(r.data)}catch(u){console.error("Error parsing JSON:",u);return}if(a.type==="system_stats")window.system_stats=a;else if(a.type==="gpu_stats")window.gpu_stats=a;else if(a.type==="network_stats")window.network_stats=a;else if(a.type==="server_settings"){if(E!=="primary"&&a.settings.second_screen&&a.settings.second_screen.value===!1){console.error("Server configuration prohibits secondary displays. This client will not function."),F&&(F.textContent="Error: Secondary displays are disabled on the server.",F.classList.remove("hidden")),d&&(d.onclose=()=>{},d.close()),ce&&(clearInterval(ce),ce=null);return}const u=Xi(a.settings);if(window.postMessage({type:"serverSettings",payload:a.settings},window.location.origin),Object.keys(u).length>0&&(console.log("Client settings were sanitized by server rules. Sending updates back to server:",u),di(u)),a.settings&&a.settings.is_manual_resolution_mode&&a.settings.is_manual_resolution_mode.value===!0){console.log("Server settings payload confirms manual mode. Switching to manual resize handlers.");const f=a.settings.manual_width?parseInt(a.settings.manual_width.value,10):0,_=a.settings.manual_height?parseInt(a.settings.manual_height.value,10):0;f>0&&_>0?(console.log(`Applying server-enforced manual resolution: ${f}x${_}`),window.is_manual_resolution_mode=!0,m=f,y=_,z(m,y,ne)):console.warn("Server dictated manual mode but did not provide valid dimensions."),Mt()}else console.log("Server settings payload confirms auto mode. Switching to auto resize handlers."),li()}else if(a.type==="server_apps")a.apps&&Array.isArray(a.apps)&&window.postMessage({type:"systemApps",apps:a.apps},window.location.origin);else if(a.type==="pipeline_status"){let u=!1;a.video!==void 0&&a.video!==N&&(N=a.video,u=!0,!N&&(k==="x264enc"||k==="x264enc-striped")&&!x&&we()),a.audio!==void 0&&a.audio!==H&&(H=a.audio,u=!0,T&&T.postMessage({type:"updatePipelineStatus",data:{isActive:H}})),u&&window.postMessage({type:"pipelineStatusUpdate",video:N,audio:H},window.location.origin)}else if(a.type==="stream_resolution"){if(x){const u=q?1:window.devicePixelRatio||1;if(P==="error"||P==="idle")console.log(`Shared mode: Received stream_resolution while in state '${P}'. Ignoring.`);else{const f=parseInt(a.width,10),_=parseInt(a.height,10);if(f>0&&_>0){const w=C(f),K=C(_),X=w/u,D=K/u;let R=m!==X||y!==D;R&&(console.log(`Shared mode: Received new stream resolution ${X.toFixed(2)}x${D.toFixed(2)} (logical).`),m=X,y=D,z(m,y,!0)),P==="ready"&&R&&W==="h264_full_frame"?(console.log("Shared mode: Triggering main decoder re-init for new resolution."),et()):P==="ready"&&R&&(console.log("Shared mode: Clearing canvas due to resolution change."),M&&g.width>0&&g.height>0&&(M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height)))}else console.warn(`Shared mode: Received invalid stream_resolution dimensions: ${a.width}x${a.height}`)}}}else console.warn("Unexpected JSON message type:",a.type,a)}else if(r.data.startsWith("cursor,"))try{const a=JSON.parse(r.data.substring(7));window.webrtcInput&&typeof window.webrtcInput.updateServerCursor=="function"&&window.webrtcInput.updateServerCursor(a)}catch(a){console.error("Error parsing cursor data:",a)}else if(r.data.startsWith("clipboard_start,")){const a=r.data.split(",");U.mimeType=a[1],U.totalSize=parseInt(a[2],10),U.receivedSize=0,U.data=[],U.inProgress=!0,console.log(`Starting multi-part clipboard download: ${U.mimeType}, total size: ${U.totalSize}`)}else if(r.data.startsWith("clipboard_data,")){if(U.inProgress)try{const a=r.data.substring(15),u=atob(a),f=u.length,_=new Uint8Array(f);for(let w=0;w<f;w++)_[w]=u.charCodeAt(w);U.data.push(_),U.receivedSize+=_.byteLength}catch(a){console.error("Error processing multi-part clipboard chunk:",a),U.inProgress=!1}}else if(r.data==="clipboard_finish"){if(U.inProgress){if(console.log(`Finished multi-part clipboard download. Received ${U.receivedSize} of ${U.totalSize} bytes.`),U.receivedSize!==U.totalSize)console.error("Multipart clipboard size mismatch. Aborting.");else try{const a=new Blob(U.data,{type:U.mimeType});if(U.mimeType==="text/plain")a.text().then(u=>{navigator.clipboard.writeText(u).catch(f=>console.error("Could not copy server clipboard text to local: "+f)),window.postMessage({type:"clipboardContentUpdate",text:u},window.location.origin)});else{const u=new ClipboardItem({[U.mimeType]:a});navigator.clipboard.write([u]).then(()=>{console.log(`Successfully wrote multi-part image (${U.mimeType}) from server to local clipboard.`);const f=`Image (${U.mimeType}) received from session and copied to clipboard.`;window.postMessage({type:"clipboardContentUpdate",text:f},window.location.origin)}).catch(f=>{console.error("Failed to write multi-part image to clipboard:",f)})}}catch(a){console.error("Error assembling final clipboard content:",a)}U.inProgress=!1,U.data=[]}}else if(r.data.startsWith("clipboard_binary,")){if(!We){console.warn("Received binary clipboard data from server, but feature is disabled on client. Ignoring.");return}try{const a=r.data.split(",");if(a.length<3){console.error("Malformed binary clipboard message from server:",r.data);return}const u=a[1],f=a[2],_=atob(f),w=_.length,K=new Uint8Array(w);for(let R=0;R<w;R++)K[R]=_.charCodeAt(R);const X=new Blob([K],{type:u}),D=new ClipboardItem({[u]:X});navigator.clipboard.write([D]).then(()=>{console.log(`Successfully wrote image (${u}) from server to local clipboard.`);const R=`Image (${u}) received from session and copied to clipboard.`;window.postMessage({type:"clipboardContentUpdate",text:R},window.location.origin)}).catch(R=>{console.error("Failed to write image to clipboard:",R)})}catch(a){console.error("Error processing binary clipboard data from server:",a)}}else if(r.data.startsWith("clipboard,"))try{const a=r.data.substring(10),u=atob(a),f=u.length,_=new Uint8Array(f);for(let K=0;K<f;K++)_[K]=u.charCodeAt(K);const w=new TextDecoder().decode(_);navigator.clipboard.writeText(w).catch(K=>console.error("Could not copy server clipboard to local: "+K)),window.postMessage({type:"clipboardContentUpdate",text:w},window.location.origin)}catch(a){console.error("Error processing clipboard data:",a)}else if(r.data.startsWith("system,"))try{JSON.parse(r.data.substring(7)).action==="reload"&&window.location.reload()}catch(a){console.error("Error parsing system data:",a)}else if(r.data==="VIDEO_STARTED"&&!x)N=!0,window.postMessage({type:"pipelineStatusUpdate",video:!0},window.location.origin);else if(r.data==="VIDEO_STOPPED"&&!x)console.log("Client: Received VIDEO_STOPPED. Updating isVideoPipelineActive=false. Expecting PIPELINE_RESETTING from server for full state reset."),N=!1,window.postMessage({type:"pipelineStatusUpdate",video:!1},window.location.origin);else if(r.data.startsWith("PIPELINE_RESETTING ")){const a=r.data.split(" "),u=a.length>1?a[1]:"primary";console.log(`[websockets] Received PIPELINE_RESETTING for display '${u}'.`),x&&u==="primary"||!x&&u===E?(Bi(`PIPELINE_RESETTING from server for display '${u}'`),x?(console.log("Shared mode: Primary pipeline reset. Re-entering identification state."),P="awaiting_identification",mt(),W=null,de=0,Ze()):console.log(`Display '${E}': Video reset complete.`)):console.log(`Ignoring PIPELINE_RESETTING for '${u}' as this client is '${x?"shared":E}'.`)}else if(r.data.startsWith("DISPLAY_CONFIG_UPDATE,"))try{const a=r.data.substring(r.data.indexOf(",")+1),u=JSON.parse(a);if(E==="primary"){const f=u.displays.includes("display2");$t!==f&&(console.log(`Secondary display connection status changed to: ${f}`),$t=f,It())}}catch(a){console.error("Error parsing DISPLAY_CONFIG_UPDATE:",a,"Original data:",r.data)}else r.data==="AUDIO_STARTED"&&!x?(H=!0,window.postMessage({type:"pipelineStatusUpdate",audio:!0},window.location.origin),T&&T.postMessage({type:"updatePipelineStatus",data:{isActive:!0}})):r.data==="AUDIO_STOPPED"&&!x?(H=!1,window.postMessage({type:"pipelineStatusUpdate",audio:!1},window.location.origin),T&&T.postMessage({type:"updatePipelineStatus",data:{isActive:!1}})):window.webrtcInput&&window.webrtcInput.on_message&&!x&&window.webrtcInput.on_message(r.data)}},d.onerror=r=>{console.error("[websockets] Error:",r),Re="error",Ke="WebSocket connection error.",Ce(),te&&(clearInterval(te),te=null),se&&(clearInterval(se),se=null),Wt(),x&&(console.error("Shared mode: WebSocket error. Resetting shared state to 'error'."),P="error",mt(),de=0)},d.onclose=r=>{if(console.log("[websockets] Connection closed",r),r.code===4001){console.error("Server rejected connection: Invalid token. Disabling reconnect."),ce&&clearInterval(ce),ce=null,Ke="Connection Failed: Invalid Token",Ce();return}else r.code===4002&&console.log("Server closed connection due to permission change. Reconnecting...");Re="disconnected",Ke="WebSocket disconnected. Attempting to reconnect...",Ce(),te&&(clearInterval(te),te=null),se&&(clearInterval(se),se=null),Wt(),ot(),nt(),v&&v.state!=="closed"&&v.close(),we(),v=null,T&&(T.postMessage({type:"close"}),T=null),x||Be(),N=!1,H=!1,Y=!1,window.postMessage({type:"pipelineStatusUpdate",video:!1,audio:!1},window.location.origin),x&&(console.log("Shared mode: WebSocket closed. Resetting shared state to 'idle'."),P="idle",mt(),de=0,W=null),ce||(ce=setInterval(()=>{d&&(d.readyState===WebSocket.OPEN||d.readyState===WebSocket.CONNECTING)||(console.log("WebSocket disconnected, reloading page to reconnect."),location.reload())},5e3))}});function ot(){let t=0;for(;$e.length>0;){const e=$e.shift();try{e.close(),t++}catch{}}t>0&&console.log(`Cleanup: Closed ${t} video frames from main buffer.`)}function nt(){let t=0;for(;xe.length>0;){const e=xe.shift();if(e&&e.image&&typeof e.image.close=="function")try{e.image.close(),t++}catch{}}t>0&&console.log(`Cleanup: Closed ${t} JPEG stripe images.`)}const $i=`
  let decoderAudio;
  let pipelineActive = true;
  let currentDecodeQueueSize = 0;
  const decoderConfig = {
    codec: 'opus',
    numberOfChannels: 2,
    sampleRate: 48000,
  };

  async function initializeDecoderInWorker() {
    if (decoderAudio && decoderAudio.state !== 'closed') {
      try { decoderAudio.close(); } catch (e) { /* ignore */ }
    }
    currentDecodeQueueSize = 0;
    decoderAudio = new AudioDecoder({
      output: handleDecodedAudioFrameInWorker,
      error: (e) => {
        console.error('[AudioWorker] AudioDecoder error:', e.message, e);
        currentDecodeQueueSize = Math.max(0, currentDecodeQueueSize -1);
        if (e.message.includes('fatal') || (decoderAudio && (decoderAudio.state === 'closed' || decoderAudio.state === 'unconfigured'))) {
          // initializeDecoderInWorker(); // Avoid rapid re-init loops on persistent errors
        }
      },
    });
    try {
      const support = await AudioDecoder.isConfigSupported(decoderConfig);
      if (support.supported) {
        await decoderAudio.configure(decoderConfig);
        self.postMessage({ type: 'decoderInitialized' });
      } else {
        decoderAudio = null;
        self.postMessage({ type: 'decoderInitFailed', reason: 'configNotSupported' });
      }
    } catch (e) {
      decoderAudio = null;
      self.postMessage({ type: 'decoderInitFailed', reason: e.message });
    }
  }

  async function handleDecodedAudioFrameInWorker(frame) {
    currentDecodeQueueSize = Math.max(0, currentDecodeQueueSize - 1);
    if (!frame || typeof frame.copyTo !== 'function' || typeof frame.allocationSize !== 'function' || typeof frame.close !== 'function') {
        if(frame && typeof frame.close === 'function') { try { frame.close(); } catch(e) { /* ignore */ } }
        return;
    }
    // In shared mode, pipelineActive is effectively always true from worker's perspective for processing
    // if (!pipelineActive) {
    //   try { frame.close(); } catch(e) { /* ignore */ }
    //   return;
    // }
    let pcmDataArrayBuffer;
    try {
      const requiredByteLength = frame.allocationSize({ planeIndex: 0, format: 'f32' });
      if (requiredByteLength === 0) {
          try { frame.close(); } catch(e) { /* ignore */ }
          return;
      }
      pcmDataArrayBuffer = new ArrayBuffer(requiredByteLength);
      const pcmDataView = new Float32Array(pcmDataArrayBuffer);
      await frame.copyTo(pcmDataView, { planeIndex: 0, format: 'f32' });
      self.postMessage({ type: 'decodedAudioData', pcmBuffer: pcmDataArrayBuffer }, [pcmDataArrayBuffer]);
      pcmDataArrayBuffer = null;
    } catch (error) { /* console.error */ }
    finally {
      if (frame && typeof frame.close === 'function') {
        try { frame.close(); } catch (e) { /* ignore */ }
      }
    }
  }

  self.onmessage = async (event) => {
    const { type, data } = event.data;
    switch (type) {
      case 'init':
        pipelineActive = data.initialPipelineStatus;
        await initializeDecoderInWorker();
        break;
      case 'decode':
        // if (!pipelineActive) return; // Allow decode even if main thread says inactive, for shared mode to always process
        if (decoderAudio && decoderAudio.state === 'configured') {
          const chunk = new EncodedAudioChunk({ type: 'key', timestamp: data.timestamp || (performance.now() * 1000), data: data.opusBuffer });
          try {
            if (currentDecodeQueueSize < 20) { // Limit queue to prevent OOM with bad data
                 decoderAudio.decode(chunk); currentDecodeQueueSize++;
            } else {
                // console.warn('[AudioWorker] Decode queue full, dropping audio chunk.');
            }
          } catch (e) {
              currentDecodeQueueSize = Math.max(0, currentDecodeQueueSize - 1);
              if (decoderAudio.state === 'closed' || decoderAudio.state === 'unconfigured') await initializeDecoderInWorker();
          }
        } else if (!decoderAudio || (decoderAudio && decoderAudio.state !== 'configuring')) {
          await initializeDecoderInWorker(); // Try to reinit if not configured
        }
        break;
      case 'reinitialize': await initializeDecoderInWorker(); break;
      case 'updatePipelineStatus': pipelineActive = data.isActive; break;
      case 'close':
        if (decoderAudio && decoderAudio.state !== 'closed') { try { decoderAudio.close(); } catch (e) { /* ignore */ } }
        decoderAudio = null; self.close(); break;
      default: break;
    }
  };
`,Rt=`
class MicWorkletProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.SILENCE_THRESHOLD_CHUNKS = 300;
    this.silentChunkCounter = 0;
    this.isSending = true;
  }
  process(inputs, outputs, parameters) {
    const input = inputs[0];
    if (input && input[0]) {
      const inputChannelData = input[0];
      const int16Array = Int16Array.from(inputChannelData, x => x * 32767);
      const isCurrentChunkSilent = int16Array.every(item => item === 0);
      if (!isCurrentChunkSilent) {
        this.isSending = true;
        this.silentChunkCounter = 0;
      } else {
        this.silentChunkCounter++;
      }
      if (this.silentChunkCounter >= this.SILENCE_THRESHOLD_CHUNKS) {
        this.isSending = false;
      }
      if (this.isSending) {
        this.port.postMessage(int16Array.buffer, [int16Array.buffer]);
      }
    }
    return true;
  }
}
registerProcessor('mic-worklet-processor', MicWorkletProcessor);
`;async function si(){if(x){console.log("Shared mode: Microphone capture blocked."),Y=!1,Ee();return}if(Y||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){Y||(Y=!1),Ee();return}let t;try{t={audio:{deviceId:Ae?{exact:Ae}:void 0,sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1},Pe=await navigator.mediaDevices.getUserMedia(t);const e=Pe.getAudioTracks();if(e.length>0){const n=e[0].getSettings();!Ae&&n.deviceId&&(Ae=n.deviceId)}ee&&ee.state!=="closed"&&await ee.close(),ee=new AudioContext({sampleRate:24e3}),ee.state==="suspended"&&await ee.resume();const i=new Blob([Rt],{type:"application/javascript"}),s=URL.createObjectURL(i);try{await ee.audioWorklet.addModule(s)}finally{URL.revokeObjectURL(s)}tt=ee.createMediaStreamSource(Pe),me=new AudioWorkletNode(ee,"mic-worklet-processor"),me.port.onmessage=n=>{const l=n.data;if(d&&d.readyState===WebSocket.OPEN&&Y){if(!l||!(l instanceof ArrayBuffer)||l.byteLength===0)return;const c=new ArrayBuffer(1+l.byteLength);new DataView(c).setUint8(0,2),new Uint8Array(c,1).set(new Uint8Array(l));try{d.send(c)}catch(h){console.error("Error sending mic data:",h)}}},me.port.onmessageerror=n=>console.error("Error from mic worklet:",n),tt.connect(me),Y=!0,Ee()}catch(e){console.error("Failed to start microphone capture:",e),alert(`Microphone error: ${e.name} - ${e.message}`),Be()}}function Be(){if(!Y&&!Pe&&!ee){Y&&(Y=!1,Ee());return}if(Pe&&(Pe.getTracks().forEach(t=>t.stop()),Pe=null),me){me.port.onmessage=null,me.port.onmessageerror=null;try{me.disconnect()}catch{}me=null}if(tt){try{tt.disconnect()}catch{}tt=null}ee&&(ee.state!=="closed"?ee.close().catch(t=>console.error("Error closing mic AudioContext:",t)).finally(()=>ee=null):ee=null),Y&&(Y=!1,Ee())}function Oi(){te&&(clearInterval(te),te=null),se&&(clearInterval(se),se=null),Wt(),!window.isCleaningUp&&(window.isCleaningUp=!0,console.log("Cleanup: Starting cleanup process..."),x||Be(),d&&(d.onopen=null,d.onmessage=null,d.onerror=null,d.onclose=null,(d.readyState===WebSocket.OPEN||d.readyState===WebSocket.CONNECTING)&&d.close(),d=null),A&&(A.state!=="closed"&&A.close().catch(t=>console.error("Cleanup error:",t)),A=null,je=null,pe=null,window.currentAudioBufferSize=0,T&&(T.postMessage({type:"close"}),T=null)),v&&v.state!=="closed"&&(v.close(),v=null),ot(),nt(),we(),Ae=null,De=null,Re="connecting",Ke="",Ne=!1,Ue=!1,F&&(F.textContent="Connecting..."),F&&F.classList.remove("hidden"),J&&J.classList.remove("hidden"),j&&(j.style.cursor="auto"),N=!0,H=!0,Y=!1,window.fps=0,Fe=0,Qe=performance.now(),console.log("Cleanup: Finished cleanup process."),window.isCleaningUp=!1)}function Ni(t){if(x){t.preventDefault(),t.dataTransfer.dropEffect="none";return}t.preventDefault(),t.dataTransfer.dropEffect="copy"}async function Ui(t){if(t.preventDefault(),t.stopPropagation(),x){console.log("Shared mode: File upload via drag-drop blocked.");return}if(!d||d.readyState!==WebSocket.OPEN){window.postMessage({type:"fileUpload",payload:{status:"error",fileName:"N/A",message:"WebSocket not open."}},window.location.origin);return}const e=[];if(t.dataTransfer.items)for(let i=0;i<t.dataTransfer.items.length;i++){const s=t.dataTransfer.items[i].webkitGetAsEntry()||t.dataTransfer.items[i].getAsEntry();s&&e.push(s)}else if(t.dataTransfer.files.length>0){for(let i=0;i<t.dataTransfer.files.length;i++)await Gt(t.dataTransfer.files[i],t.dataTransfer.files[i].name);return}try{for(const i of e)await ui(i)}catch(i){const s=`Error during sequential upload: ${i.message||i}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:"N/A",message:s}},window.location.origin),d&&d.readyState===WebSocket.OPEN&&d.send("FILE_UPLOAD_ERROR:GENERAL:Processing failed")}}function Wi(t){return new Promise((e,i)=>t.file(e,i))}async function ui(t,e=""){let i;if(t.fullPath&&typeof t.fullPath=="string"&&t.fullPath!==t.name&&(t.fullPath.includes("/")||t.fullPath.includes("\\"))?(i=t.fullPath,i.startsWith("/")&&(i=i.substring(1)),console.log(`Using entry.fullPath: "${i}" for entry.name: "${t.name}"`)):(i=e?`${e}/${t.name}`:t.name,console.log(`Constructed path: "${i}" for entry.name: "${t.name}" (basePathFallback: "${e}")`)),t.isFile)try{const s=await Wi(t);await Gt(s,i)}catch(s){console.error(`Error processing file ${i}: ${s}`),window.postMessage({type:"fileUpload",payload:{status:"error",fileName:i,message:`Error processing file: ${s.message||s}`}},window.location.origin),d&&d.readyState===WebSocket.OPEN&&d.send(`FILE_UPLOAD_ERROR:${i}:Client-side file processing error`)}else if(t.isDirectory){console.log(`Processing directory: ${i}`);const s=t.createReader();let n;do{n=await new Promise((l,c)=>s.readEntries(l,c));for(const l of n)await ui(l,i)}while(n.length>0)}}function Gt(t,e){return new Promise((i,s)=>{if(!d||d.readyState!==WebSocket.OPEN){const p=`WS closed for ${e}.`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:p}},window.location.origin),s(new Error(p));return}window.postMessage({type:"fileUpload",payload:{status:"start",fileName:e,fileSize:t.size}},window.location.origin),d.send(`FILE_UPLOAD_START:${e}:${t.size}`);let n=0;At[e]=0;const l=new FileReader;l.onload=function(p){if(!d||d.readyState!==WebSocket.OPEN){const h=`WS closed during upload of ${e}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:h}},window.location.origin),s(new Error(h));return}if(p.target.error){const h=`File read error for ${e}: ${p.target.error}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:h}},window.location.origin),d.send(`FILE_UPLOAD_ERROR:${e}:File read error`),s(p.target.error);return}try{const h=new Uint8Array(1+p.target.result.byteLength);h[0]=1,h.set(new Uint8Array(p.target.result),1),d.send(h.buffer),n+=p.target.result.byteLength;const b=t.size>0?Math.round(n/t.size*100):100,S=Date.now();S-At[e]>mi&&(window.postMessage({type:"fileUpload",payload:{status:"progress",fileName:e,progress:b,fileSize:t.size}},window.location.origin),At[e]=S),n<t.size?setTimeout(()=>c(n),0):(window.postMessage({type:"fileUpload",payload:{status:"progress",fileName:e,progress:100,fileSize:t.size}},window.location.origin),d.send(`FILE_UPLOAD_END:${e}`),window.postMessage({type:"fileUpload",payload:{status:"end",fileName:e,fileSize:t.size}},window.location.origin),i())}catch(h){const b=`WS send error during upload of ${e}: ${h.message||h}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:b}},window.location.origin),d.send(`FILE_UPLOAD_ERROR:${e}:WS send error`),s(h)}},l.onerror=function(p){const h=`General file reader error for ${e}: ${p.target.error}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:h}},window.location.origin),d.send(`FILE_UPLOAD_ERROR:${e}:General file reader error`),s(p.target.error)};function c(p){if(!d||d.readyState!==WebSocket.OPEN){const b=`WS closed before reading next chunk of ${e}`;window.postMessage({type:"fileUpload",payload:{status:"error",fileName:e,message:b}},window.location.origin),s(new Error(b));return}const h=t.slice(p,Math.min(p+_i,t.size));l.readAsArrayBuffer(h)}c(0)})}function Bi(t="unknown"){if(console.log(`Performing server-initiated video reset. Reason: ${t}. Current lastReceivedVideoFrameId before reset: ${ge}`),x&&(Je=!1,console.log("  Shared mode reset: Gate closed. Waiting for a new keyframe.")),ge=-1,console.log(`  Reset lastReceivedVideoFrameId to ${ge}.`),ot(),nt(),ke=[],k==="x264enc"||k==="x264enc-striped")we();else if(k!=="jpeg"){if(v&&v.state!=="closed"){console.log("  Closing main video decoder due to server reset.");try{v.close()}catch(e){console.warn("  Error closing main video decoder during reset:",e)}}v=null,console.log("  Main video decoder instance set to null.")}if(M&&g&&!(k==="x264enc"||k==="x264enc-striped"))try{M.setTransform(1,0,0,1,0,0),M.clearRect(0,0,g.width,g.height),console.log("  Cleared canvas during server-initiated reset.")}catch(e){console.error("  Error clearing canvas during server-initiated reset:",e)}x||k!=="jpeg"&&k!=="x264enc"&&k!=="x264enc-striped"&&(console.log("  Ensuring main video decoder is re-initialized after server reset."),N?et():console.log("  isVideoPipelineActive is false, decoder re-initialization deferred until video is enabled by user."))}function Ge(t,e){if(console.error(`FATAL DECODER ERROR (Context: ${e}).`,t),!window.isFallingBack){if(window.isFallingBack=!0,d&&d.readyState===WebSocket.OPEN&&(d.onclose=null,d.close()),te&&(clearInterval(te),te=null),x)console.log("Shared client fallback: Reloading page to re-sync with the stream."),F&&(F.textContent="A video error occurred. Reloading to re-sync with the stream...",F.classList.remove("hidden"));else{console.log("Primary client fallback: Forcing client settings to safe defaults.");const i=`${ye}_crash_count`;let s=parseInt(window.localStorage.getItem(i)||"0");s++,window.localStorage.setItem(i,s.toString()),s>=3?(ht("encoder","jpeg"),window.localStorage.setItem(i,"0")):ht("encoder","x264enc"),V("h264_fullcolor",!1),$("framerate",60),$("h264_crf",25),V("is_manual_resolution_mode",!1),$("manual_width",null),$("manual_height",null),F&&(F.textContent="A critical video error occurred. Resetting to default settings and reloading...",F.classList.remove("hidden"))}setTimeout(()=>{window.location.reload()},3e3)}}function zi(){return Mi(),window.isSecureContext?typeof window.VideoDecoder>"u"?(console.error("FATAL: Browser does not support the VideoDecoder API."),F&&(F.textContent="Error: Your browser does not support the WebCodecs API required for video streaming.",F.classList.remove("hidden")),J&&J.classList.add("hidden"),!1):(console.log("Pre-flight checks passed: Secure context and VideoDecoder API are available."),!0):(console.error("FATAL: Not in a secure context. WebCodecs require HTTPS."),F&&(F.textContent="Error: This application requires a secure connection (HTTPS). Please check the URL.",F.classList.remove("hidden")),J&&J.classList.add("hidden"),!1)}window.addEventListener("beforeunload",Oi);window.webrtcInput=null;
